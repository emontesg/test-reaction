{"metadata":{},"options":{"plugins":[{"key":"base$0$0","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"generateLetDeclarations":true,"enforceStrictMode":false}},{"key":"transform-meteor-dynamic-import","visitor":{"_exploded":{},"_verified":{},"CallExpression":{"enter":[null]}},"options":{}},{"key":"base$0$2","visitor":{"CallExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"MemberExpression":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true,"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"polyfill":false,"useBuiltIns":false}},{"key":"base$0$3","visitor":{"_exploded":{},"_verified":{},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]}},"options":{"loose":true}},{"key":"base$0$4","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$5","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$6","visitor":{"Program":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"allowTopLevelThis":true,"strictMode":false,"loose":true}},{"key":"base$0$1$0","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"Program":{"enter":[null],"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","throwIfNamespace":true,"useBuiltIns":false}},{"key":"base$0$1$1","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$1$2","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$1","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$2","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$3","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$4","visitor":{"VariableDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"_exploded":true,"BlockStatement":{"enter":[null]},"SwitchStatement":{"enter":[null]},"Program":{"enter":[null]},"_verified":true,"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"base$0$0$5","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"base$0$0$6","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"base$0$0$7","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"base$0$0$8","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"base$0$0$9","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$10","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$11","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]}},"options":{}},{"key":"base$0$0$12","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$13","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$14","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$15","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"base$0$0$16","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]}},"options":{}},{"key":"base$0$0$17","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$18","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$19","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"base$0$0$20","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$21","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"base$0$0$22","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$23","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"regenerator-transform","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]}},"options":{}}],"presets":[],"compact":false,"ast":true,"babelrc":false,"sourceFileName":"client/modules/core/helpers/apps.js","filename":"client/modules/core/helpers/apps.js","sourceMaps":true,"envName":"development","cwd":"/Users/estebandev/test-knowledge","passPerPreset":false,"parserOpts":{"sourceType":"module","sourceFileName":"client/modules/core/helpers/apps.js","plugins":["dynamicImport","classProperties","jsx","jsx","flow","asyncGenerators","objectRestSpread","objectRestSpread","flow","asyncGenerators"]},"generatorOpts":{"filename":"client/modules/core/helpers/apps.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"client/modules/core/helpers/apps.js"}},"code":"module.export({\n  Apps: function () {\n    return Apps;\n  }\n});\n\nvar _cloneDeep;\n\nmodule.watch(require(\"lodash/cloneDeep\"), {\n  \"default\": function (v) {\n    _cloneDeep = v;\n  }\n}, 0);\n\nvar _filter;\n\nmodule.watch(require(\"lodash/filter\"), {\n  \"default\": function (v) {\n    _filter = v;\n  }\n}, 1);\nvar Template;\nmodule.watch(require(\"meteor/templating\"), {\n  Template: function (v) {\n    Template = v;\n  }\n}, 2);\nvar Meteor;\nmodule.watch(require(\"meteor/meteor\"), {\n  Meteor: function (v) {\n    Meteor = v;\n  }\n}, 3);\nvar Roles;\nmodule.watch(require(\"meteor/alanning:roles\"), {\n  Roles: function (v) {\n    Roles = v;\n  }\n}, 4);\nvar Reaction;\nmodule.watch(require(\"../../../api\"), {\n  Reaction: function (v) {\n    Reaction = v;\n  }\n}, 5);\nvar Packages, Shops;\nmodule.watch(require(\"../../../../lib/collections\"), {\n  Packages: function (v) {\n    Packages = v;\n  },\n  Shops: function (v) {\n    Shops = v;\n  }\n}, 6);\n\nfunction Apps(optionHash) {\n  var filter = {};\n  var registryFilter = {};\n  var key;\n  var reactionApps = [];\n  var options = {}; // allow for object or option.hash\n\n  if (optionHash) {\n    if (optionHash.hash) {\n      options = optionHash.hash;\n    } else {\n      options = optionHash;\n    }\n  } // you could provide a shopId in optionHash\n\n\n  if (!options.shopId) {\n    options.shopId = Reaction.getShopId();\n  } // Get the shop to determine shopType\n\n\n  var shop = Shops.findOne({\n    _id: options.shopId\n  }) || {};\n  var shopType = shop.shopType; // remove audience permissions for owner (still needed here for older/legacy calls)\n\n  if (Reaction.hasOwnerAccess() && options.audience) {\n    delete options.audience;\n  } //\n  // build filter to only get matching registry elements\n  //\n\n\n  for (key in meteorBabelHelpers.sanitizeForInObject(options)) {\n    if ({}.hasOwnProperty.call(options, key)) {\n      var value = options[key];\n\n      if (value) {\n        if (!(key === \"enabled\" || key === \"name\" || key === \"shopId\")) {\n          filter[\"registry.\" + key] = Array.isArray(options[key]) ? {\n            $in: value\n          } : value;\n          registryFilter[key] = value;\n        } else {\n          // perhaps not the best way to check but lets admin see all packages\n          if (!Reaction.hasOwnerAccess()) {\n            if (key !== \"shopId\") {\n              registryFilter[key] = value;\n            }\n          }\n\n          filter[key] = value;\n        }\n      }\n    }\n  }\n\n  delete filter[\"registry.audience\"]; // Temporarily remove \"audience\" key (see comment below)\n  // TODO: Review fix for filter on Packages.find(filter)\n  // The current \"filter\" setup uses \"audience\" field which is not present in the registry array in most (if not all) docs\n  // in the Packages coll.\n  // For now, the audience checks (after the Package.find call) filters out the registry items based on permissions. But\n  // part of the filtering should have been handled by the Package.find call, if the \"audience\" filter works as it should.\n\n  Packages.find(filter).forEach(function (app) {\n    var matchingRegistry = _filter(app.registry, function (item) {\n      var itemFilter = _cloneDeep(registryFilter); // check audience permissions only if they exist as part of optionHash and are part of the registry item\n      // ideally all routes should use it, safe for backwards compatibility though\n      // owner bypasses permissions\n\n\n      if (!Reaction.hasOwnerAccess() && item.permissions && registryFilter.audience) {\n        var hasAccess;\n\n        for (var _iterator = registryFilter.audience, _isArray = Array.isArray(_iterator), _i = 0, _iterator = _isArray ? _iterator : _iterator[Symbol.iterator]();;) {\n          var _ref;\n\n          if (_isArray) {\n            if (_i >= _iterator.length) break;\n            _ref = _iterator[_i++];\n          } else {\n            _i = _iterator.next();\n            if (_i.done) break;\n            _ref = _i.value;\n          }\n\n          var _permission = _ref;\n          // This checks that the registry item contains a permissions matches with the user's permission for the shop\n          var hasPermissionToRegistryItem = item.permissions.indexOf(_permission) > -1; // This checks that the user's permission set have the right value that is on the registry item\n\n          var hasRoleAccessForShop = Roles.userIsInRole(Meteor.userId(), _permission, Reaction.getShopId()); // both checks must pass for access to be granted\n\n          if (hasPermissionToRegistryItem && hasRoleAccessForShop) {\n            hasAccess = true;\n            break;\n          }\n        }\n\n        if (!hasAccess) {\n          return false;\n        } // safe to clean up now, and isMatch can ignore audience\n\n\n        delete itemFilter.audience;\n      } // Check that shopType matches showForShopType if option is present\n\n\n      if (item.showForShopTypes && Array.isArray(item.showForShopTypes) && item.showForShopTypes.indexOf(shopType) === -1) {\n        return false;\n      } // Check that shopType does not match hideForShopType if option is present\n\n\n      if (item.hideForShopTypes && Array.isArray(item.hideForShopTypes) && item.hideForShopTypes.indexOf(shopType) !== -1) {\n        return false;\n      } // Loop through all keys in the itemFilter\n      // each filter item should match exactly with the property in the registry or\n      // should be included in the array if that property is an array\n\n\n      return Object.keys(itemFilter).every(function (property) {\n        var filterVal = itemFilter[property];\n        var itemVal = item[property]; // Check to see if the registry entry is an array.\n        // Legacy registry entries could exist that use a string even when the schema requires an array.\n        // If it's not an array, the filter should match exactly\n\n        return Array.isArray(itemVal) ? itemVal.includes(filterVal) : itemVal === filterVal;\n      });\n    });\n\n    for (var _iterator2 = matchingRegistry, _isArray2 = Array.isArray(_iterator2), _i2 = 0, _iterator2 = _isArray2 ? _iterator2 : _iterator2[Symbol.iterator]();;) {\n      var _ref2;\n\n      if (_isArray2) {\n        if (_i2 >= _iterator2.length) break;\n        _ref2 = _iterator2[_i2++];\n      } else {\n        _i2 = _iterator2.next();\n        if (_i2.done) break;\n        _ref2 = _i2.value;\n      }\n\n      var _registry = _ref2;\n      reactionApps.push(_registry);\n    }\n  }); // Sort apps by priority (registry.priority)\n\n  return reactionApps.sort(function (a, b) {\n    return a.priority - b.priority;\n  }).slice();\n}\n\n// Register global template helper\nTemplate.registerHelper(\"reactionApps\", function (optionHash) {\n  return Reaction.Apps(optionHash);\n});","map":{"version":3,"sources":["client/modules/core/helpers/apps.js"],"names":["module","export","Apps","_cloneDeep","watch","require","v","_filter","Template","Meteor","Roles","Reaction","Packages","Shops","optionHash","filter","registryFilter","key","reactionApps","options","hash","shopId","getShopId","shop","findOne","_id","shopType","hasOwnerAccess","audience","hasOwnProperty","call","value","Array","isArray","$in","find","forEach","app","matchingRegistry","registry","item","itemFilter","permissions","hasAccess","permission","hasPermissionToRegistryItem","indexOf","hasRoleAccessForShop","userIsInRole","userId","showForShopTypes","hideForShopTypes","Object","keys","every","property","filterVal","itemVal","includes","push","sort","a","b","priority","slice","registerHelper"],"mappings":"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","sourcesContent":["import _ from \"lodash\";\nimport { Template } from \"meteor/templating\";\nimport { Meteor } from \"meteor/meteor\";\nimport { Roles } from \"meteor/alanning:roles\";\nimport { Reaction } from \"/client/api\";\nimport { Packages, Shops } from \"/lib/collections\";\n\n/**\n *\n * reactionApps\n *   provides=\"<where matching registry provides is this >\"\n *   enabled=true <false for disabled packages>\n *   context= true filter templates to current route\n *   returns matching package registry objects\n *   @example {{#each reactionApps provides=\"settings\" name=packageName container=container}}\n *   @example {{#each reactionApps provides=\"userAccountDropdown\" enabled=true}}\n *   @example\n *     {{#each reactionApps provides=\"social\" name=\"reaction-social\"}}\n *         {{> Template.dynamic template=template data=customSocialSettings }}\n *     {{/each}}\n *\n *   @typedef optionHash\n *   @type {object}\n *   @property {string} name - name of a package.\n *   @property {string} provides -purpose of this package as identified to the registry\n *   @property {string} container - filter registry entries for matching container.\n *   @property {string} shopId - filter to only display results matching shopId, not returned\n *   @property {string} template - filter registry entries for matching template\n *   @type {optionHash}\n *\n *  @return {optionHash} returns an array of filtered, structure reactionApps\n *  [{\n *   enabled: true\n *   label: \"Stripe\"\n *   name: \"reaction-stripe\"\n *   packageId: \"QqkGsQCDRhg2LSn8J\"\n *   priority: 1\n *   provides: \"paymentMethod\"\n *   template: \"stripePaymentForm\"\n *   etc: \"additional properties as defined in Packages.registry\"\n *   ...\n *  }]\n */\n\nexport function Apps(optionHash) {\n  const filter = {};\n  const registryFilter = {};\n  let key;\n  const reactionApps = [];\n  let options = {};\n\n  // allow for object or option.hash\n  if (optionHash) {\n    if (optionHash.hash) {\n      options = optionHash.hash;\n    } else {\n      options = optionHash;\n    }\n  }\n\n  // you could provide a shopId in optionHash\n  if (!options.shopId) {\n    options.shopId = Reaction.getShopId();\n  }\n\n  // Get the shop to determine shopType\n  const shop = Shops.findOne({ _id: options.shopId }) || {};\n  const { shopType } = shop;\n\n  // remove audience permissions for owner (still needed here for older/legacy calls)\n  if (Reaction.hasOwnerAccess() && options.audience) {\n    delete options.audience;\n  }\n\n  //\n  // build filter to only get matching registry elements\n  //\n  for (key in options) {\n    if ({}.hasOwnProperty.call(options, key)) {\n      const value = options[key];\n      if (value) {\n        if (!(key === \"enabled\" || key === \"name\" || key === \"shopId\")) {\n          filter[`registry.${key}`] = Array.isArray(options[key]) ? { $in: value } : value;\n          registryFilter[key] = value;\n        } else {\n          // perhaps not the best way to check but lets admin see all packages\n          if (!Reaction.hasOwnerAccess()) {\n            if (key !== \"shopId\") {\n              registryFilter[key] = value;\n            }\n          }\n          filter[key] = value;\n        }\n      }\n    }\n  }\n\n  delete filter[\"registry.audience\"]; // Temporarily remove \"audience\" key (see comment below)\n\n  // TODO: Review fix for filter on Packages.find(filter)\n  // The current \"filter\" setup uses \"audience\" field which is not present in the registry array in most (if not all) docs\n  // in the Packages coll.\n  // For now, the audience checks (after the Package.find call) filters out the registry items based on permissions. But\n  // part of the filtering should have been handled by the Package.find call, if the \"audience\" filter works as it should.\n  Packages.find(filter).forEach((app) => {\n    const matchingRegistry = _.filter(app.registry, (item) => {\n      const itemFilter = _.cloneDeep(registryFilter);\n\n      // check audience permissions only if they exist as part of optionHash and are part of the registry item\n      // ideally all routes should use it, safe for backwards compatibility though\n      // owner bypasses permissions\n      if (!Reaction.hasOwnerAccess() && item.permissions && registryFilter.audience) {\n        let hasAccess;\n\n        for (const permission of registryFilter.audience) {\n          // This checks that the registry item contains a permissions matches with the user's permission for the shop\n          const hasPermissionToRegistryItem = item.permissions.indexOf(permission) > -1;\n          // This checks that the user's permission set have the right value that is on the registry item\n          const hasRoleAccessForShop = Roles.userIsInRole(Meteor.userId(), permission, Reaction.getShopId());\n\n          // both checks must pass for access to be granted\n          if (hasPermissionToRegistryItem && hasRoleAccessForShop) {\n            hasAccess = true;\n            break;\n          }\n        }\n\n        if (!hasAccess) {\n          return false;\n        }\n\n        // safe to clean up now, and isMatch can ignore audience\n        delete itemFilter.audience;\n      }\n\n      // Check that shopType matches showForShopType if option is present\n      if (item.showForShopTypes &&\n          Array.isArray(item.showForShopTypes) &&\n          item.showForShopTypes.indexOf(shopType) === -1) {\n        return false;\n      }\n\n      // Check that shopType does not match hideForShopType if option is present\n      if (item.hideForShopTypes &&\n          Array.isArray(item.hideForShopTypes) &&\n          item.hideForShopTypes.indexOf(shopType) !== -1) {\n        return false;\n      }\n\n      // Loop through all keys in the itemFilter\n      // each filter item should match exactly with the property in the registry or\n      // should be included in the array if that property is an array\n      return Object.keys(itemFilter).every((property) => {\n        const filterVal = itemFilter[property];\n        const itemVal = item[property];\n\n        // Check to see if the registry entry is an array.\n        // Legacy registry entries could exist that use a string even when the schema requires an array.\n        // If it's not an array, the filter should match exactly\n        return Array.isArray(itemVal) ? itemVal.includes(filterVal) : itemVal === filterVal;\n      });\n    });\n\n    for (const registry of matchingRegistry) {\n      reactionApps.push(registry);\n    }\n  });\n\n  // Sort apps by priority (registry.priority)\n  return reactionApps.sort((a, b) => a.priority - b.priority).slice();\n}\n\n// Register global template helper\nTemplate.registerHelper(\"reactionApps\", (optionHash) => Reaction.Apps(optionHash));\n"]},"sourceType":"script","hash":"b602f52df0db9186df6a4c23e7821d5746b8a299"}
