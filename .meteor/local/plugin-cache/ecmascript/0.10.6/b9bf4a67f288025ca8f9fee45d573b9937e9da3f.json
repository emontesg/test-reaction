{"metadata":{},"options":{"plugins":[{"key":"base$0$0","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"generateLetDeclarations":true,"enforceStrictMode":false}},{"key":"transform-meteor-dynamic-import","visitor":{"_exploded":{},"_verified":{},"CallExpression":{"enter":[null]}},"options":{}},{"key":"base$0$2","visitor":{"CallExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"MemberExpression":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true,"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"polyfill":false,"useBuiltIns":false}},{"key":"base$0$3","visitor":{"_exploded":{},"_verified":{},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]}},"options":{"loose":true}},{"key":"base$0$4","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$5","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$6","visitor":{"Program":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"allowTopLevelThis":true,"strictMode":false,"loose":true}},{"key":"base$0$1$0","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"Program":{"enter":[null],"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","throwIfNamespace":true,"useBuiltIns":false}},{"key":"base$0$1$1","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$1$2","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$1","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$2","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$3","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$4","visitor":{"VariableDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"_exploded":true,"BlockStatement":{"enter":[null]},"SwitchStatement":{"enter":[null]},"Program":{"enter":[null]},"_verified":true,"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"base$0$0$5","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"base$0$0$6","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"base$0$0$7","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"base$0$0$8","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"base$0$0$9","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$10","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$11","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]}},"options":{}},{"key":"base$0$0$12","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$13","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$14","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$15","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"base$0$0$16","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]}},"options":{}},{"key":"base$0$0$17","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$18","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$19","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"base$0$0$20","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$21","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"base$0$0$22","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$23","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"regenerator-transform","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]}},"options":{}}],"presets":[],"compact":false,"ast":true,"babelrc":false,"sourceFileName":"imports/plugins/core/shipping/client/templates/checkout/shipping.js","filename":"imports/plugins/core/shipping/client/templates/checkout/shipping.js","sourceMaps":true,"envName":"development","cwd":"/Users/estebandev/test-knowledge","passPerPreset":false,"parserOpts":{"sourceType":"module","sourceFileName":"imports/plugins/core/shipping/client/templates/checkout/shipping.js","plugins":["dynamicImport","classProperties","jsx","jsx","flow","asyncGenerators","objectRestSpread","objectRestSpread","flow","asyncGenerators"]},"generatorOpts":{"filename":"imports/plugins/core/shipping/client/templates/checkout/shipping.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"imports/plugins/core/shipping/client/templates/checkout/shipping.js"}},"code":"var _isEqual;\n\nmodule.watch(require(\"lodash/isEqual\"), {\n  \"default\": function (v) {\n    _isEqual = v;\n  }\n}, 0);\n\nvar _uniq;\n\nmodule.watch(require(\"lodash/uniq\"), {\n  \"default\": function (v) {\n    _uniq = v;\n  }\n}, 1);\nvar Meteor;\nmodule.watch(require(\"meteor/meteor\"), {\n  Meteor: function (v) {\n    Meteor = v;\n  }\n}, 2);\nvar EJSON;\nmodule.watch(require(\"meteor/ejson\"), {\n  EJSON: function (v) {\n    EJSON = v;\n  }\n}, 3);\nvar Template;\nmodule.watch(require(\"meteor/templating\"), {\n  Template: function (v) {\n    Template = v;\n  }\n}, 4);\nvar ReactiveDict;\nmodule.watch(require(\"meteor/reactive-dict\"), {\n  ReactiveDict: function (v) {\n    ReactiveDict = v;\n  }\n}, 5);\nvar Reaction;\nmodule.watch(require(\"../../../../../../../client/api\"), {\n  Reaction: function (v) {\n    Reaction = v;\n  }\n}, 6);\nvar Cart;\nmodule.watch(require(\"../../../../../../../lib/collections\"), {\n  Cart: function (v) {\n    Cart = v;\n  }\n}, 7);\n\n// Because we are duplicating shipment quotes across shipping records\n// we will get duplicate shipping quotes but we only want to diplay one\n// So this function eliminates duplicates\n\n/**\n * Return a unique list of objects\n * @param {Array} objs - An array of objects\n * @returns {Array} An array of object only containing unique members\n * @private\n */\nfunction uniqObjects(objs) {\n  var jsonBlobs = objs.map(function (obj) {\n    return JSON.stringify(obj);\n  });\n\n  var uniqueBlobs = _uniq(jsonBlobs);\n\n  return uniqueBlobs.map(function (blob) {\n    return EJSON.parse(blob);\n  });\n} // cartShippingQuotes\n// returns multiple methods\n\n/**\n * cartShippingQuotes - returns a list of all the shipping costs/quotations\n * of each available shipping carrier like UPS, Fedex etc.\n * @param {Object} currentCart - The current cart that's about\n * to be checked out.\n * @returns {Array} - an array of the quotations of multiple shipping\n * carriers.\n */\n\n\nfunction cartShippingQuotes(currentCart) {\n  var cart = currentCart || Cart.findOne();\n  var shipmentQuotes = [];\n\n  if (cart) {\n    if (cart.shipping) {\n      for (var _iterator = cart.shipping, _isArray = Array.isArray(_iterator), _i = 0, _iterator = _isArray ? _iterator : _iterator[Symbol.iterator]();;) {\n        var _ref;\n\n        if (_isArray) {\n          if (_i >= _iterator.length) break;\n          _ref = _iterator[_i++];\n        } else {\n          _i = _iterator.next();\n          if (_i.done) break;\n          _ref = _i.value;\n        }\n\n        var _shipping = _ref;\n\n        if (_shipping.shipmentQuotes) {\n          for (var _iterator2 = _shipping.shipmentQuotes, _isArray2 = Array.isArray(_iterator2), _i2 = 0, _iterator2 = _isArray2 ? _iterator2 : _iterator2[Symbol.iterator]();;) {\n            var _ref2;\n\n            if (_isArray2) {\n              if (_i2 >= _iterator2.length) break;\n              _ref2 = _iterator2[_i2++];\n            } else {\n              _i2 = _iterator2.next();\n              if (_i2.done) break;\n              _ref2 = _i2.value;\n            }\n\n            var _quote = _ref2;\n            shipmentQuotes.push(_quote);\n          }\n        }\n      }\n    }\n  }\n\n  return uniqObjects(shipmentQuotes);\n}\n\nfunction shippingMethodsQueryStatus(currentCart) {\n  var cart = currentCart || Cart.findOne();\n  var queryStatus;\n  var failingShippingProvider;\n\n  if (cart) {\n    if (cart.shipping) {\n      for (var _iterator3 = cart.shipping, _isArray3 = Array.isArray(_iterator3), _i3 = 0, _iterator3 = _isArray3 ? _iterator3 : _iterator3[Symbol.iterator]();;) {\n        var _ref3;\n\n        if (_isArray3) {\n          if (_i3 >= _iterator3.length) break;\n          _ref3 = _iterator3[_i3++];\n        } else {\n          _i3 = _iterator3.next();\n          if (_i3.done) break;\n          _ref3 = _i3.value;\n        }\n\n        var _shipping2 = _ref3;\n        var quotesQueryStatus = _shipping2.shipmentQuotesQueryStatus;\n\n        if (quotesQueryStatus) {\n          queryStatus = quotesQueryStatus.requestStatus;\n        }\n\n        if (queryStatus === \"error\") {\n          failingShippingProvider = quotesQueryStatus.shippingProvider;\n        }\n      }\n    }\n  }\n\n  return [queryStatus, failingShippingProvider];\n}\n/**\n * cartShipmentMethods - gets current shipment methods.\n * @return {Array} - Returns multiple methods if more than one\n * carrier has been chosen.\n */\n\n\nfunction cartShipmentMethods() {\n  var cart = Cart.findOne();\n  var shipmentMethods = [];\n\n  if (cart) {\n    if (cart.shipping) {\n      for (var _iterator4 = cart.shipping, _isArray4 = Array.isArray(_iterator4), _i4 = 0, _iterator4 = _isArray4 ? _iterator4 : _iterator4[Symbol.iterator]();;) {\n        var _ref4;\n\n        if (_isArray4) {\n          if (_i4 >= _iterator4.length) break;\n          _ref4 = _iterator4[_i4++];\n        } else {\n          _i4 = _iterator4.next();\n          if (_i4.done) break;\n          _ref4 = _i4.value;\n        }\n\n        var _shipping3 = _ref4;\n        shipmentMethods.push(_shipping3.shipmentMethod);\n      }\n    }\n  }\n\n  return shipmentMethods;\n}\n\nfunction enabledShipping() {\n  var enabledShippingArr = [];\n  var apps = Reaction.Apps({\n    provides: \"shippingSettings\",\n    enabled: true,\n    shopId: Reaction.getPrimaryShopId()\n  });\n\n  for (var _iterator5 = apps, _isArray5 = Array.isArray(_iterator5), _i5 = 0, _iterator5 = _isArray5 ? _iterator5 : _iterator5[Symbol.iterator]();;) {\n    var _ref5;\n\n    if (_isArray5) {\n      if (_i5 >= _iterator5.length) break;\n      _ref5 = _iterator5[_i5++];\n    } else {\n      _i5 = _iterator5.next();\n      if (_i5.done) break;\n      _ref5 = _i5.value;\n    }\n\n    var _app = _ref5;\n    if (_app.enabled === true) enabledShippingArr.push(_app);\n  }\n\n  return enabledShippingArr;\n}\n\nTemplate.coreCheckoutShipping.onCreated(function () {\n  var _this = this;\n\n  this.autorun(function () {\n    _this.subscribe(\"Shipping\");\n  });\n  this.state = new ReactiveDict();\n  this.state.setDefault({\n    isLoadingShippingMethods: true\n  });\n  var enabled = enabledShipping();\n  var isEnabled = enabled.length;\n  var shippingOpts = {\n    provides: \"settings\",\n    name: \"settings/shipping\",\n    template: \"shippingSettings\"\n  }; // If shipping not set, show shipping settings dashboard\n\n  if (!isEnabled) {\n    Reaction.showActionView(shippingOpts);\n  }\n});\nTemplate.coreCheckoutShipping.helpers({\n  // retrieves current rates and updates shipping rates\n  // in the users cart collection (historical, and prevents repeated rate lookup)\n  shipmentQuotes: function () {\n    var instance = Template.instance();\n\n    if (instance.subscriptionsReady()) {\n      var cart = Cart.findOne(); // isLoadingShippingMethods is updated here because, when this template\n      // reacts to a change in data, this method is called before hasShippingMethods().\n\n      var isLoadingShippingMethods = shippingMethodsQueryStatus()[0] === \"pending\";\n      instance.state.set(\"isLoadingShippingMethods\", isLoadingShippingMethods);\n      var shippingQuotes = cartShippingQuotes(cart);\n      return shippingQuotes;\n    }\n  },\n  hasShippingMethods: function () {\n    var instance = Template.instance();\n    var isLoadingShippingMethods = instance.state.get(\"isLoadingShippingMethods\");\n\n    if (isLoadingShippingMethods) {\n      return true;\n    } // Useful for when shipping methods are enabled, but querying them fails\n    // due to internet connection issues.\n\n\n    var quotesQueryStatus = shippingMethodsQueryStatus();\n    var didAllQueriesFail = quotesQueryStatus[0] === \"error\" && quotesQueryStatus[1] === \"all\";\n\n    if (didAllQueriesFail) {\n      return false;\n    }\n\n    var hasEnabledShippingProviders = enabledShipping().length > 0;\n\n    if (hasEnabledShippingProviders) {\n      return true;\n    }\n\n    return false;\n  },\n  // helper to display currently selected shipmentMethod\n  isSelected: function () {\n    var self = this;\n    var shipmentMethods = cartShipmentMethods();\n\n    for (var _iterator6 = shipmentMethods, _isArray6 = Array.isArray(_iterator6), _i6 = 0, _iterator6 = _isArray6 ? _iterator6 : _iterator6[Symbol.iterator]();;) {\n      var _ref6;\n\n      if (_isArray6) {\n        if (_i6 >= _iterator6.length) break;\n        _ref6 = _iterator6[_i6++];\n      } else {\n        _i6 = _iterator6.next();\n        if (_i6.done) break;\n        _ref6 = _i6.value;\n      }\n\n      var _method = _ref6;\n\n      // if there is already a selected method, set active\n      if (_isEqual(self.method, _method)) {\n        return \"active\";\n      }\n    }\n\n    return null;\n  },\n  isReady: function () {\n    var instance = Template.instance();\n    var isReady = instance.subscriptionsReady();\n\n    if (Reaction.Subscriptions.Cart.ready()) {\n      if (isReady) {\n        return true;\n      }\n    }\n\n    return false;\n  },\n\n  /**\n   * Template helper that checks to see if the user has permissions for the shop\n   * responsible for shipping rates. This is the primary shop unless\n   * `merchantShippingRates` is enabled in marketplace\n   * @method isAdmin\n   * @return {Boolean} true if the user has admin access, otherwise false\n   */\n  isAdmin: function () {\n    var marketplaceSettings = Reaction.marketplace;\n\n    if (marketplaceSettings && marketplaceSettings.merchantShippingRates) {\n      Reaction.hasAdminAccess();\n    }\n\n    return Reaction.hasAdminAccess(Reaction.getPrimaryShopId());\n  }\n}); //\n// Set and store cart shipmentMethod\n// this copies from shipmentMethods (retrieved rates)\n// to shipmentMethod (selected rate)\n//\n\nTemplate.coreCheckoutShipping.events({\n  \"click .list-group-item\": function (event) {\n    event.preventDefault();\n    event.stopPropagation();\n    var cart = Cart.findOne();\n    Meteor.call(\"cart/setShipmentMethod\", cart._id, this.method, function (error) {\n      if (error) throw new Meteor.Error(\"set-shipment-method-error\", error.message);\n    });\n  },\n  \"click [data-event-action=configure-shipping]\": function (event) {\n    event.preventDefault();\n    var dashboardRegistryEntry = Reaction.Apps({\n      name: \"reaction-dashboard\",\n      provides: \"shortcut\"\n    });\n    var shippingRegistryEntry = Reaction.Apps({\n      name: \"reaction-shipping\",\n      provides: \"settings\"\n    });\n    Reaction.showActionView([dashboardRegistryEntry[0], shippingRegistryEntry[0]]);\n  }\n});","map":{"version":3,"sources":["imports/plugins/core/shipping/client/templates/checkout/shipping.js"],"names":["_isEqual","module","watch","require","v","_uniq","Meteor","EJSON","Template","ReactiveDict","Reaction","Cart","uniqObjects","objs","jsonBlobs","map","obj","JSON","stringify","uniqueBlobs","blob","parse","cartShippingQuotes","currentCart","cart","findOne","shipmentQuotes","shipping","quote","push","shippingMethodsQueryStatus","queryStatus","failingShippingProvider","quotesQueryStatus","shipmentQuotesQueryStatus","requestStatus","shippingProvider","cartShipmentMethods","shipmentMethods","shipmentMethod","enabledShipping","enabledShippingArr","apps","Apps","provides","enabled","shopId","getPrimaryShopId","app","coreCheckoutShipping","onCreated","autorun","subscribe","state","setDefault","isLoadingShippingMethods","isEnabled","length","shippingOpts","name","template","showActionView","helpers","instance","subscriptionsReady","set","shippingQuotes","hasShippingMethods","get","didAllQueriesFail","hasEnabledShippingProviders","isSelected","self","method","isReady","Subscriptions","ready","isAdmin","marketplaceSettings","marketplace","merchantShippingRates","hasAdminAccess","events","event","preventDefault","stopPropagation","call","_id","error","Error","message","dashboardRegistryEntry","shippingRegistryEntry"],"mappings":"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","sourcesContent":["import _ from \"lodash\";\nimport { Meteor } from \"meteor/meteor\";\nimport { EJSON } from \"meteor/ejson\";\nimport { Template } from \"meteor/templating\";\nimport { ReactiveDict } from \"meteor/reactive-dict\";\nimport { Reaction } from \"/client/api\";\nimport { Cart } from \"/lib/collections\";\n\n// Because we are duplicating shipment quotes across shipping records\n// we will get duplicate shipping quotes but we only want to diplay one\n// So this function eliminates duplicates\n/**\n * Return a unique list of objects\n * @param {Array} objs - An array of objects\n * @returns {Array} An array of object only containing unique members\n * @private\n */\nfunction uniqObjects(objs) {\n  const jsonBlobs = objs.map((obj) => JSON.stringify(obj));\n  const uniqueBlobs = _.uniq(jsonBlobs);\n  return uniqueBlobs.map((blob) => EJSON.parse(blob));\n}\n\n// cartShippingQuotes\n// returns multiple methods\n/**\n * cartShippingQuotes - returns a list of all the shipping costs/quotations\n * of each available shipping carrier like UPS, Fedex etc.\n * @param {Object} currentCart - The current cart that's about\n * to be checked out.\n * @returns {Array} - an array of the quotations of multiple shipping\n * carriers.\n */\nfunction cartShippingQuotes(currentCart) {\n  const cart = currentCart || Cart.findOne();\n  const shipmentQuotes = [];\n  if (cart) {\n    if (cart.shipping) {\n      for (const shipping of cart.shipping) {\n        if (shipping.shipmentQuotes) {\n          for (const quote of shipping.shipmentQuotes) {\n            shipmentQuotes.push(quote);\n          }\n        }\n      }\n    }\n  }\n  return uniqObjects(shipmentQuotes);\n}\n\nfunction shippingMethodsQueryStatus(currentCart) {\n  const cart = currentCart || Cart.findOne();\n  let queryStatus;\n  let failingShippingProvider;\n\n  if (cart) {\n    if (cart.shipping) {\n      for (const shipping of cart.shipping) {\n        const quotesQueryStatus = shipping.shipmentQuotesQueryStatus;\n        if (quotesQueryStatus) {\n          queryStatus = quotesQueryStatus.requestStatus;\n        }\n        if (queryStatus === \"error\") {\n          failingShippingProvider = quotesQueryStatus.shippingProvider;\n        }\n      }\n    }\n  }\n\n  return [queryStatus, failingShippingProvider];\n}\n\n/**\n * cartShipmentMethods - gets current shipment methods.\n * @return {Array} - Returns multiple methods if more than one\n * carrier has been chosen.\n */\nfunction cartShipmentMethods() {\n  const cart = Cart.findOne();\n  const shipmentMethods = [];\n  if (cart) {\n    if (cart.shipping) {\n      for (const shipping of cart.shipping) {\n        shipmentMethods.push(shipping.shipmentMethod);\n      }\n    }\n  }\n  return shipmentMethods;\n}\n\nfunction enabledShipping() {\n  const enabledShippingArr = [];\n  const apps = Reaction.Apps({\n    provides: \"shippingSettings\",\n    enabled: true,\n    shopId: Reaction.getPrimaryShopId()\n  });\n  for (const app of apps) {\n    if (app.enabled === true) enabledShippingArr.push(app);\n  }\n  return enabledShippingArr;\n}\n\nTemplate.coreCheckoutShipping.onCreated(function () {\n  this.autorun(() => {\n    this.subscribe(\"Shipping\");\n  });\n\n  this.state = new ReactiveDict();\n  this.state.setDefault({\n    isLoadingShippingMethods: true\n  });\n\n  const enabled = enabledShipping();\n  const isEnabled = enabled.length;\n  const shippingOpts = {\n    provides: \"settings\",\n    name: \"settings/shipping\",\n    template: \"shippingSettings\"\n  };\n\n  // If shipping not set, show shipping settings dashboard\n  if (!isEnabled) {\n    Reaction.showActionView(shippingOpts);\n  }\n});\n\nTemplate.coreCheckoutShipping.helpers({\n  // retrieves current rates and updates shipping rates\n  // in the users cart collection (historical, and prevents repeated rate lookup)\n  shipmentQuotes() {\n    const instance = Template.instance();\n    if (instance.subscriptionsReady()) {\n      const cart = Cart.findOne();\n\n      // isLoadingShippingMethods is updated here because, when this template\n      // reacts to a change in data, this method is called before hasShippingMethods().\n      const isLoadingShippingMethods = shippingMethodsQueryStatus()[0] === \"pending\";\n      instance.state.set(\"isLoadingShippingMethods\", isLoadingShippingMethods);\n\n      const shippingQuotes = cartShippingQuotes(cart);\n      return shippingQuotes;\n    }\n  },\n\n  hasShippingMethods() {\n    const instance = Template.instance();\n    const isLoadingShippingMethods = instance.state.get(\"isLoadingShippingMethods\");\n    if (isLoadingShippingMethods) {\n      return true;\n    }\n\n    // Useful for when shipping methods are enabled, but querying them fails\n    // due to internet connection issues.\n    const quotesQueryStatus = shippingMethodsQueryStatus();\n    const didAllQueriesFail =\n      quotesQueryStatus[0] === \"error\" && quotesQueryStatus[1] === \"all\";\n    if (didAllQueriesFail) {\n      return false;\n    }\n\n    const hasEnabledShippingProviders = enabledShipping().length > 0;\n    if (hasEnabledShippingProviders) {\n      return true;\n    }\n\n    return false;\n  },\n\n  // helper to display currently selected shipmentMethod\n  isSelected() {\n    const self = this;\n    const shipmentMethods = cartShipmentMethods();\n\n    for (const method of shipmentMethods) {\n      // if there is already a selected method, set active\n      if (_.isEqual(self.method, method)) {\n        return \"active\";\n      }\n    }\n    return null;\n  },\n\n  isReady() {\n    const instance = Template.instance();\n    const isReady = instance.subscriptionsReady();\n\n    if (Reaction.Subscriptions.Cart.ready()) {\n      if (isReady) {\n        return true;\n      }\n    }\n\n    return false;\n  },\n\n  /**\n   * Template helper that checks to see if the user has permissions for the shop\n   * responsible for shipping rates. This is the primary shop unless\n   * `merchantShippingRates` is enabled in marketplace\n   * @method isAdmin\n   * @return {Boolean} true if the user has admin access, otherwise false\n   */\n  isAdmin() {\n    const marketplaceSettings = Reaction.marketplace;\n    if (marketplaceSettings && marketplaceSettings.merchantShippingRates) {\n      Reaction.hasAdminAccess();\n    }\n    return Reaction.hasAdminAccess(Reaction.getPrimaryShopId());\n  }\n});\n\n//\n// Set and store cart shipmentMethod\n// this copies from shipmentMethods (retrieved rates)\n// to shipmentMethod (selected rate)\n//\nTemplate.coreCheckoutShipping.events({\n  \"click .list-group-item\"(event) {\n    event.preventDefault();\n    event.stopPropagation();\n    const cart = Cart.findOne();\n\n    Meteor.call(\"cart/setShipmentMethod\", cart._id, this.method, (error) => {\n      if (error) throw new Meteor.Error(\"set-shipment-method-error\", error.message);\n    });\n  },\n  \"click [data-event-action=configure-shipping]\"(event) {\n    event.preventDefault();\n\n    const dashboardRegistryEntry = Reaction.Apps({ name: \"reaction-dashboard\", provides: \"shortcut\" });\n    const shippingRegistryEntry = Reaction.Apps({ name: \"reaction-shipping\", provides: \"settings\" });\n\n    Reaction.showActionView([\n      dashboardRegistryEntry[0],\n      shippingRegistryEntry[0]\n    ]);\n  }\n});\n"]},"sourceType":"script","hash":"b9bf4a67f288025ca8f9fee45d573b9937e9da3f"}
