{"metadata":{},"options":{"plugins":[{"key":"base$1$0","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"Program":{"enter":[null],"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","throwIfNamespace":true,"useBuiltIns":false}},{"key":"base$1$1","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$1$2","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"generateLetDeclarations":true,"enforceStrictMode":false}},{"key":"base$0$1","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$2","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"base$0$3","visitor":{"CallExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"MemberExpression":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true,"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"polyfill":false,"useBuiltIns":true}},{"key":"base$0$4","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$5","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"transform-meteor-dynamic-import","visitor":{"_exploded":{},"_verified":{},"CallExpression":{"enter":[null]}},"options":{}},{"key":"base$0$8","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"base$0$9","visitor":{"Program":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"allowTopLevelThis":true,"strictMode":false,"loose":true}},{"key":"base$0$10","visitor":{"_exploded":{},"_verified":{},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]}},"options":{"loose":true}}],"compact":false,"ast":true,"babelrc":false,"sourceFileName":"imports/plugins/included/connectors-shopify/server/jobs/order-export.js","filename":"imports/plugins/included/connectors-shopify/server/jobs/order-export.js","sourceMaps":true,"envName":"development","cwd":"/Users/estebandev/test-knowledge","passPerPreset":false,"presets":[],"parserOpts":{"sourceType":"module","sourceFileName":"imports/plugins/included/connectors-shopify/server/jobs/order-export.js","plugins":["jsx","jsx","flow","flow","objectRestSpread","objectRestSpread","dynamicImport","asyncGenerators","classProperties"]},"generatorOpts":{"filename":"imports/plugins/included/connectors-shopify/server/jobs/order-export.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"imports/plugins/included/connectors-shopify/server/jobs/order-export.js"}},"code":"let Orders, Jobs;\nmodule.watch(require(\"/lib/collections\"), {\n  Orders(v) {\n    Orders = v;\n  },\n\n  Jobs(v) {\n    Jobs = v;\n  }\n\n}, 0);\nlet Logger;\nmodule.watch(require(\"/server/api\"), {\n  Logger(v) {\n    Logger = v;\n  }\n\n}, 1);\nlet exportToShopify;\nmodule.watch(require(\"../methods/export/orders\"), {\n  exportToShopify(v) {\n    exportToShopify = v;\n  }\n\n}, 2);\n\n/**\n * @private\n * @summary Mark orders as exported after export\n * @param {Object} order - the order to mark as failed\n */\nfunction markExportFailed(order) {\n  const shops = Object.keys(order.getItemsByShop());\n  shops.forEach(shopId => {\n    Orders.update({\n      _id: order._id\n    }, {\n      $push: {\n        exportHistory: {\n          status: \"failure\",\n          dateAttempted: new Date(),\n          exportMethod: \"reaction-connectors-shopify\",\n          shopId\n        }\n      }\n    });\n  });\n}\n\nmodule.exportDefault(() => {\n  const exportOrders = Jobs.processJobs(\"connectors/shopify/export/order\", {\n    pollInterval: 5 * 60 * 1000,\n    // Retry failed orders after 5 minutes\n    workTimeout: 30 * 1000\n  }, (job, callback) => {\n    Logger.info(\"Starting exportOrders job\");\n    const {\n      orderId\n    } = job.data;\n    const order = Orders.findOne(orderId);\n\n    try {\n      exportToShopify(order).then(exportedOrders => {\n        Logger.debug(\"exported order(s)\", exportedOrders);\n      }).catch(error => {\n        Logger.error(\"Encountered error when exporting to shopify\", error);\n\n        if (error.response && error.response.body) {\n          Logger.error(error.response.body);\n        }\n\n        markExportFailed(order);\n      });\n      job.done(`Finished exporting order ${orderId}`);\n      callback();\n    } catch (error) {\n      job.fail(`Failed to export order ${orderId}.`);\n      callback();\n    }\n  });\n  Jobs.find({\n    type: \"connectors/shopify/export/order\",\n    status: \"ready\"\n  }).observe({\n    added() {\n      return exportOrders.trigger();\n    }\n\n  });\n});","map":{"version":3,"sources":["imports/plugins/included/connectors-shopify/server/jobs/order-export.js"],"names":["Orders","Jobs","module","watch","require","v","Logger","exportToShopify","markExportFailed","order","shops","Object","keys","getItemsByShop","forEach","shopId","update","_id","$push","exportHistory","status","dateAttempted","Date","exportMethod","exportDefault","exportOrders","processJobs","pollInterval","workTimeout","job","callback","info","orderId","data","findOne","then","exportedOrders","debug","catch","error","response","body","done","fail","find","type","observe","added","trigger"],"mappings":"AAAA,IAAIA,MAAJ,EAAWC,IAAX;AAAgBC,OAAOC,KAAP,CAAaC,QAAQ,kBAAR,CAAb,EAAyC;AAACJ,SAAOK,CAAP,EAAS;AAACL,aAAOK,CAAP;AAAS,GAApB;;AAAqBJ,OAAKI,CAAL,EAAO;AAACJ,WAAKI,CAAL;AAAO;;AAApC,CAAzC,EAA+E,CAA/E;AAAkF,IAAIC,MAAJ;AAAWJ,OAAOC,KAAP,CAAaC,QAAQ,aAAR,CAAb,EAAoC;AAACE,SAAOD,CAAP,EAAS;AAACC,aAAOD,CAAP;AAAS;;AAApB,CAApC,EAA0D,CAA1D;AAA6D,IAAIE,eAAJ;AAAoBL,OAAOC,KAAP,CAAaC,QAAQ,0BAAR,CAAb,EAAiD;AAACG,kBAAgBF,CAAhB,EAAkB;AAACE,sBAAgBF,CAAhB;AAAkB;;AAAtC,CAAjD,EAAyF,CAAzF;;AAI9L;;;;;AAKA,SAASG,gBAAT,CAA0BC,KAA1B,EAAiC;AAC/B,QAAMC,QAAQC,OAAOC,IAAP,CAAYH,MAAMI,cAAN,EAAZ,CAAd;AACAH,QAAMI,OAAN,CAAeC,MAAD,IAAY;AACxBf,WAAOgB,MAAP,CAAc;AAAEC,WAAKR,MAAMQ;AAAb,KAAd,EAAkC;AAChCC,aAAO;AACLC,uBAAe;AACbC,kBAAQ,SADK;AAEbC,yBAAe,IAAIC,IAAJ,EAFF;AAGbC,wBAAc,6BAHD;AAIbR;AAJa;AADV;AADyB,KAAlC;AAUD,GAXD;AAYD;;AAvBDb,OAAOsB,aAAP,CA0Be,MAAM;AACnB,QAAMC,eAAexB,KAAKyB,WAAL,CAAiB,iCAAjB,EAAoD;AACvEC,kBAAc,IAAI,EAAJ,GAAS,IADgD;AAC1C;AAC7BC,iBAAa,KAAK;AAFqD,GAApD,EAGlB,CAACC,GAAD,EAAMC,QAAN,KAAmB;AACpBxB,WAAOyB,IAAP,CAAY,2BAAZ;AACA,UAAM;AAAEC;AAAF,QAAcH,IAAII,IAAxB;AACA,UAAMxB,QAAQT,OAAOkC,OAAP,CAAeF,OAAf,CAAd;;AACA,QAAI;AACFzB,sBAAgBE,KAAhB,EACG0B,IADH,CACSC,cAAD,IAAoB;AACxB9B,eAAO+B,KAAP,CAAa,mBAAb,EAAkCD,cAAlC;AACD,OAHH,EAIGE,KAJH,CAIUC,KAAD,IAAW;AAChBjC,eAAOiC,KAAP,CAAa,6CAAb,EAA4DA,KAA5D;;AACA,YAAIA,MAAMC,QAAN,IAAkBD,MAAMC,QAAN,CAAeC,IAArC,EAA2C;AACzCnC,iBAAOiC,KAAP,CAAaA,MAAMC,QAAN,CAAeC,IAA5B;AACD;;AACDjC,yBAAiBC,KAAjB;AACD,OAVH;AAWAoB,UAAIa,IAAJ,CAAU,4BAA2BV,OAAQ,EAA7C;AACAF;AACD,KAdD,CAcE,OAAOS,KAAP,EAAc;AACdV,UAAIc,IAAJ,CAAU,0BAAyBX,OAAQ,GAA3C;AACAF;AACD;AACF,GAzBoB,CAArB;AA0BA7B,OAAK2C,IAAL,CAAU;AACRC,UAAM,iCADE;AAERzB,YAAQ;AAFA,GAAV,EAGG0B,OAHH,CAGW;AACTC,YAAQ;AACN,aAAOtB,aAAauB,OAAb,EAAP;AACD;;AAHQ,GAHX;AAQD,CA7DD","sourcesContent":["import { Orders, Jobs } from \"/lib/collections\";\nimport { Logger } from \"/server/api\";\nimport { exportToShopify } from \"../methods/export/orders\";\n\n/**\n * @private\n * @summary Mark orders as exported after export\n * @param {Object} order - the order to mark as failed\n */\nfunction markExportFailed(order) {\n  const shops = Object.keys(order.getItemsByShop());\n  shops.forEach((shopId) => {\n    Orders.update({ _id: order._id }, {\n      $push: {\n        exportHistory: {\n          status: \"failure\",\n          dateAttempted: new Date(),\n          exportMethod: \"reaction-connectors-shopify\",\n          shopId\n        }\n      }\n    });\n  });\n}\n\n\nexport default () => {\n  const exportOrders = Jobs.processJobs(\"connectors/shopify/export/order\", {\n    pollInterval: 5 * 60 * 1000, // Retry failed orders after 5 minutes\n    workTimeout: 30 * 1000\n  }, (job, callback) => {\n    Logger.info(\"Starting exportOrders job\");\n    const { orderId } = job.data;\n    const order = Orders.findOne(orderId);\n    try {\n      exportToShopify(order)\n        .then((exportedOrders) => {\n          Logger.debug(\"exported order(s)\", exportedOrders);\n        })\n        .catch((error) => {\n          Logger.error(\"Encountered error when exporting to shopify\", error);\n          if (error.response && error.response.body) {\n            Logger.error(error.response.body);\n          }\n          markExportFailed(order);\n        });\n      job.done(`Finished exporting order ${orderId}`);\n      callback();\n    } catch (error) {\n      job.fail(`Failed to export order ${orderId}.`);\n      callback();\n    }\n  });\n  Jobs.find({\n    type: \"connectors/shopify/export/order\",\n    status: \"ready\"\n  }).observe({\n    added() {\n      return exportOrders.trigger();\n    }\n  });\n};\n"]},"sourceType":"script","hash":"1e6f32dc3399ded5ba885ef321ce06db92236ef7"}
