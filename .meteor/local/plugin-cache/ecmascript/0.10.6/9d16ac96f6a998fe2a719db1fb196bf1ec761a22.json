{"metadata":{},"options":{"plugins":[{"key":"base$0$0","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"generateLetDeclarations":true,"enforceStrictMode":false}},{"key":"transform-meteor-dynamic-import","visitor":{"_exploded":{},"_verified":{},"CallExpression":{"enter":[null]}},"options":{}},{"key":"base$0$2","visitor":{"CallExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"MemberExpression":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true,"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"polyfill":false,"useBuiltIns":false}},{"key":"base$0$3","visitor":{"_exploded":{},"_verified":{},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]}},"options":{"loose":true}},{"key":"base$0$4","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$5","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$6","visitor":{"Program":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"allowTopLevelThis":true,"strictMode":false,"loose":true}},{"key":"base$0$1$0","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"Program":{"enter":[null],"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","throwIfNamespace":true,"useBuiltIns":false}},{"key":"base$0$1$1","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$1$2","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$1","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$2","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$3","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$4","visitor":{"VariableDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"_exploded":true,"BlockStatement":{"enter":[null]},"SwitchStatement":{"enter":[null]},"Program":{"enter":[null]},"_verified":true,"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"base$0$0$5","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"base$0$0$6","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"base$0$0$7","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"base$0$0$8","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"base$0$0$9","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$10","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$11","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]}},"options":{}},{"key":"base$0$0$12","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$13","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$14","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$15","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"base$0$0$16","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]}},"options":{}},{"key":"base$0$0$17","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$18","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$19","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"base$0$0$20","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$21","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"base$0$0$22","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$23","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"regenerator-transform","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]}},"options":{}}],"presets":[],"compact":false,"ast":true,"babelrc":false,"sourceFileName":"client/modules/core/startup.js","filename":"client/modules/core/startup.js","sourceMaps":true,"envName":"development","cwd":"/Users/estebandev/test-knowledge","passPerPreset":false,"parserOpts":{"sourceType":"module","sourceFileName":"client/modules/core/startup.js","plugins":["dynamicImport","classProperties","jsx","jsx","flow","asyncGenerators","objectRestSpread","objectRestSpread","flow","asyncGenerators"]},"generatorOpts":{"filename":"client/modules/core/startup.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"client/modules/core/startup.js"}},"code":"var store;\nmodule.watch(require(\"store\"), {\n  \"default\": function (v) {\n    store = v;\n  }\n}, 0);\nvar Meteor;\nmodule.watch(require(\"meteor/meteor\"), {\n  Meteor: function (v) {\n    Meteor = v;\n  }\n}, 1);\nvar Tracker;\nmodule.watch(require(\"meteor/tracker\"), {\n  Tracker: function (v) {\n    Tracker = v;\n  }\n}, 2);\nvar AccountsCollection;\nmodule.watch(require(\"../../../lib/collections\"), {\n  Accounts: function (v) {\n    AccountsCollection = v;\n  }\n}, 3);\nvar Accounts;\nmodule.watch(require(\"meteor/accounts-base\"), {\n  Accounts: function (v) {\n    Accounts = v;\n  }\n}, 4);\nvar Reaction, Logger;\nmodule.watch(require(\"../../api\"), {\n  Reaction: function (v) {\n    Reaction = v;\n  },\n  Logger: function (v) {\n    Logger = v;\n  }\n}, 5);\nvar userPrefs;\nmodule.watch(require(\"./main\"), {\n  userPrefs: function (v) {\n    userPrefs = v;\n  }\n}, 6);\nvar cookieName = \"_RcFallbackLoginToken\";\n/**\n *  Startup Reaction\n *  Init Reaction client\n */\n\nMeteor.startup(function () {\n  // init the core\n  Reaction.init(); // initialize anonymous guest users\n\n  Tracker.autorun(function () {\n    var userId = Meteor.userId(); // Load data from Accounts collection into the localStorage\n\n    Tracker.nonreactive(function () {\n      // Don't load the data from Accounts Collection again when something changes\n      // as we are already storing everything in the localStorage reactively\n      try {\n        var user = AccountsCollection.findOne(userId);\n\n        if (user && user.profile && user.profile.preferences) {\n          Object.keys(user.profile.preferences).forEach(function (packageName) {\n            var packageSettings = user.profile.preferences[packageName];\n            Object.keys(packageSettings).forEach(function (preference) {\n              if (packageName === \"reaction\" && preference === \"activeShopId\") {\n                // Because activeShopId is cached on client side.\n                Reaction.setShopId(packageSettings[preference]);\n              } else {\n                Reaction.setUserPreferences(packageName, preference, packageSettings[preference]);\n              }\n            });\n          });\n        }\n      } catch (err) {\n        Logger.error(\"Problem in loading user preferences from Accounts collection\");\n      }\n    });\n\n    if (userId && !isLocalStorageAvailable() && !readCookie(cookieName)) {\n      Logger.debug(\"No local storage available. About to set up fallback login \" + \"mechanism with cookie login token.\");\n      Meteor.call(\"accounts/createFallbackLoginToken\", function (err, token) {\n        if (!err && token) {\n          window.onbeforeunload = function () {\n            return createSessionCookie(cookieName, token);\n          };\n\n          return;\n        } // Can't set login cookie. Fail silently.\n\n\n        Logger.error(\"Setting up fallback login mechanism failed!\");\n      });\n    } // TODO: maybe `visibilityState` will be better here\n\n\n    var loggingIn;\n    var sessionId;\n    Tracker.nonreactive(function () {\n      loggingIn = Accounts.loggingIn();\n      sessionId = store.get(\"Reaction.session\");\n    });\n\n    if (!userId) {\n      if (!loggingIn || typeof sessionId !== \"string\") {\n        if (!isLocalStorageAvailable() && readCookie(cookieName)) {\n          // If re-login through local storage fails, RC falls back\n          // to cookie-based login. E.g. Applies for Safari browser in\n          // incognito mode.\n          Accounts.loginWithToken(readCookie(cookieName));\n        } else {\n          Accounts.loginWithAnonymous();\n        }\n      }\n    }\n  }); // Set up an autorun to get fine-grained reactivity on only the\n  // user preferences\n\n  Tracker.autorun(function () {\n    var userId = Meteor.userId();\n    if (!userId) return;\n    var user = Meteor.users.findOne(userId, {\n      fields: {\n        profile: 1\n      }\n    });\n    userPrefs.set(user && user.profile && user.profile.preferences || undefined);\n  });\n});\n\nfunction isLocalStorageAvailable() {\n  try {\n    localStorage.testKey = \"testValue\";\n  } catch (e) {\n    return false;\n  }\n\n  delete localStorage.testKey;\n  return true;\n}\n\nfunction readCookie(name) {\n  var nameEq = name + \"=\";\n  var ca = document.cookie.split(\";\");\n\n  for (var i = 0; i < ca.length; i += 1) {\n    var c = ca[i];\n\n    while (c.charAt(0) === \" \") {\n      c = c.substring(1, c.length);\n    }\n\n    if (c.indexOf(nameEq) === 0) {\n      return c.substring(nameEq.length, c.length);\n    }\n  }\n\n  return null;\n}\n\nfunction createSessionCookie(name, value) {\n  document.cookie = name + \"=\" + value + \"; path=/\";\n}","map":{"version":3,"sources":["client/modules/core/startup.js"],"names":["store","module","watch","require","v","Meteor","Tracker","AccountsCollection","Accounts","Reaction","Logger","userPrefs","cookieName","startup","init","autorun","userId","nonreactive","user","findOne","profile","preferences","Object","keys","forEach","packageName","packageSettings","preference","setShopId","setUserPreferences","err","error","isLocalStorageAvailable","readCookie","debug","call","token","window","onbeforeunload","createSessionCookie","loggingIn","sessionId","get","loginWithToken","loginWithAnonymous","users","fields","set","undefined","localStorage","testKey","e","name","nameEq","ca","document","cookie","split","i","length","c","charAt","substring","indexOf","value"],"mappings":"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","sourcesContent":["import store from \"store\";\nimport { Meteor } from \"meteor/meteor\";\nimport { Tracker } from \"meteor/tracker\";\nimport { Accounts as AccountsCollection } from \"/lib/collections\";\nimport { Accounts } from \"meteor/accounts-base\";\n\nimport { Reaction, Logger } from \"/client/api\";\nimport { userPrefs } from \"./main\";\n\nconst cookieName = \"_RcFallbackLoginToken\";\n\n/**\n *  Startup Reaction\n *  Init Reaction client\n */\nMeteor.startup(() => {\n  // init the core\n  Reaction.init();\n\n  // initialize anonymous guest users\n  Tracker.autorun(() => {\n    const userId = Meteor.userId();\n\n    // Load data from Accounts collection into the localStorage\n    Tracker.nonreactive(() => {\n      // Don't load the data from Accounts Collection again when something changes\n      // as we are already storing everything in the localStorage reactively\n      try {\n        const user = AccountsCollection.findOne(userId);\n        if (user && user.profile && user.profile.preferences) {\n          Object.keys(user.profile.preferences).forEach((packageName) => {\n            const packageSettings = user.profile.preferences[packageName];\n            Object.keys(packageSettings).forEach((preference) => {\n              if (packageName === \"reaction\" && preference === \"activeShopId\") {\n                // Because activeShopId is cached on client side.\n                Reaction.setShopId(packageSettings[preference]);\n              } else {\n                Reaction.setUserPreferences(packageName, preference, packageSettings[preference]);\n              }\n            });\n          });\n        }\n      } catch (err) {\n        Logger.error(\"Problem in loading user preferences from Accounts collection\");\n      }\n    });\n\n    if (userId && !isLocalStorageAvailable() && !readCookie(cookieName)) {\n      Logger.debug(\"No local storage available. About to set up fallback login \" +\n        \"mechanism with cookie login token.\");\n      Meteor.call(\"accounts/createFallbackLoginToken\", (err, token) => {\n        if (!err && token) {\n          window.onbeforeunload = () => createSessionCookie(cookieName, token);\n          return;\n        }\n        // Can't set login cookie. Fail silently.\n        Logger.error(\"Setting up fallback login mechanism failed!\");\n      });\n    }\n\n    // TODO: maybe `visibilityState` will be better here\n    let loggingIn;\n    let sessionId;\n    Tracker.nonreactive(() => {\n      loggingIn = Accounts.loggingIn();\n      sessionId = store.get(\"Reaction.session\");\n    });\n\n    if (!userId) {\n      if (!loggingIn || typeof sessionId !== \"string\") {\n        if (!isLocalStorageAvailable() && readCookie(cookieName)) {\n          // If re-login through local storage fails, RC falls back\n          // to cookie-based login. E.g. Applies for Safari browser in\n          // incognito mode.\n          Accounts.loginWithToken(readCookie(cookieName));\n        } else {\n          Accounts.loginWithAnonymous();\n        }\n      }\n    }\n  });\n\n  // Set up an autorun to get fine-grained reactivity on only the\n  // user preferences\n  Tracker.autorun(() => {\n    const userId = Meteor.userId();\n    if (!userId) return;\n    const user = Meteor.users.findOne(userId, { fields: { profile: 1 } });\n    userPrefs.set((user && user.profile && user.profile.preferences) || undefined);\n  });\n});\n\nfunction isLocalStorageAvailable() {\n  try {\n    localStorage.testKey = \"testValue\";\n  } catch (e) {\n    return false;\n  }\n  delete localStorage.testKey;\n  return true;\n}\n\nfunction readCookie(name) {\n  const nameEq = `${name}=`;\n  const ca = document.cookie.split(\";\");\n  for (let i = 0; i < ca.length; i += 1) {\n    let c = ca[i];\n    while (c.charAt(0) === \" \") c = c.substring(1, c.length);\n    if (c.indexOf(nameEq) === 0) {\n      return c.substring(nameEq.length, c.length);\n    }\n  }\n  return null;\n}\n\nfunction createSessionCookie(name, value) {\n  document.cookie = `${name}=${value}; path=/`;\n}\n"]},"sourceType":"script","hash":"9d16ac96f6a998fe2a719db1fb196bf1ec761a22"}
