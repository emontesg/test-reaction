{"metadata":{},"options":{"plugins":[{"key":"base$0$0","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"generateLetDeclarations":true,"enforceStrictMode":false}},{"key":"transform-meteor-dynamic-import","visitor":{"_exploded":{},"_verified":{},"CallExpression":{"enter":[null]}},"options":{}},{"key":"base$0$2","visitor":{"CallExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"MemberExpression":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true,"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"polyfill":false,"useBuiltIns":false}},{"key":"base$0$3","visitor":{"_exploded":{},"_verified":{},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]}},"options":{"loose":true}},{"key":"base$0$4","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$5","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$6","visitor":{"Program":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"allowTopLevelThis":true,"strictMode":false,"loose":true}},{"key":"base$0$1$0","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"Program":{"enter":[null],"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","throwIfNamespace":true,"useBuiltIns":false}},{"key":"base$0$1$1","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$1$2","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$1","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$2","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$3","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$4","visitor":{"VariableDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"_exploded":true,"BlockStatement":{"enter":[null]},"SwitchStatement":{"enter":[null]},"Program":{"enter":[null]},"_verified":true,"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"base$0$0$5","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"base$0$0$6","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"base$0$0$7","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"base$0$0$8","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"base$0$0$9","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$10","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$11","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]}},"options":{}},{"key":"base$0$0$12","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$13","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$14","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$15","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"base$0$0$16","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]}},"options":{}},{"key":"base$0$0$17","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$18","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$19","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"base$0$0$20","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$21","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"base$0$0$22","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$23","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"regenerator-transform","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]}},"options":{}}],"presets":[],"compact":false,"ast":true,"babelrc":false,"sourceFileName":"imports/plugins/core/orders/client/templates/workflow/shippingTracking.js","filename":"imports/plugins/core/orders/client/templates/workflow/shippingTracking.js","sourceMaps":true,"envName":"development","cwd":"/Users/estebandev/test-knowledge","passPerPreset":false,"parserOpts":{"sourceType":"module","sourceFileName":"imports/plugins/core/orders/client/templates/workflow/shippingTracking.js","plugins":["dynamicImport","classProperties","jsx","jsx","flow","asyncGenerators","objectRestSpread","objectRestSpread","flow","asyncGenerators"]},"generatorOpts":{"filename":"imports/plugins/core/orders/client/templates/workflow/shippingTracking.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"imports/plugins/core/orders/client/templates/workflow/shippingTracking.js"}},"code":"var Meteor;\nmodule.watch(require(\"meteor/meteor\"), {\n  Meteor: function (v) {\n    Meteor = v;\n  }\n}, 0);\nvar Tracker;\nmodule.watch(require(\"meteor/tracker\"), {\n  Tracker: function (v) {\n    Tracker = v;\n  }\n}, 1);\nvar ReactiveVar;\nmodule.watch(require(\"meteor/reactive-var\"), {\n  ReactiveVar: function (v) {\n    ReactiveVar = v;\n  }\n}, 2);\nvar Template;\nmodule.watch(require(\"meteor/templating\"), {\n  Template: function (v) {\n    Template = v;\n  }\n}, 3);\nvar i18next, Reaction;\nmodule.watch(require(\"../../../../../../../client/api\"), {\n  i18next: function (v) {\n    i18next = v;\n  },\n  Reaction: function (v) {\n    Reaction = v;\n  }\n}, 4);\nvar Orders;\nmodule.watch(require(\"../../../../../../../lib/collections\"), {\n  Orders: function (v) {\n    Orders = v;\n  }\n}, 5);\nvar getShippingInfo;\nmodule.watch(require(\"../../helpers\"), {\n  getShippingInfo: function (v) {\n    getShippingInfo = v;\n  }\n}, 6);\nTemplate.coreOrderShippingTracking.onCreated(function () {\n  var template = Template.instance();\n  var currentData = Template.currentData();\n  template.orderDep = new Tracker.Dependency();\n  template.showTrackingEditForm = ReactiveVar(false);\n\n  function getOrder(orderId, shipmentId) {\n    template.orderDep.depend();\n    return Orders.findOne({\n      \"_id\": orderId,\n      \"shipping._id\": shipmentId\n    });\n  }\n\n  Tracker.autorun(function () {\n    template.order = getOrder(currentData.orderId, currentData.fulfillment && currentData.fulfillment._id);\n  });\n});\n/**\n * coreShipmentShipped events\n *\n */\n\nTemplate.coreOrderShippingTracking.events({\n  \"click [data-event-action=refresh-shipping]\": function () {\n    var instance = Template.instance();\n    instance.$(\"#btn-processing\").removeClass(\"hidden\");\n\n    var orderId = Template.instance().order._id;\n\n    Meteor.call(\"shipping/status/refresh\", orderId, function (result) {\n      if (result && result.error) {\n        instance.$(\"#btn-processing\").addClass(\"hidden\");\n        Alerts.toast(i18next.t(\"orderShipping.labelError\", {\n          error: result.error\n        }), \"error\", {\n          timeout: 7000\n        });\n      }\n    });\n  },\n  \"click [data-event-action=shipmentShipped]\": function () {\n    var template = Template.instance();\n    var shipment = getShippingInfo(template.order);\n    Meteor.call(\"orders/shipmentShipped\", template.order, shipment, function (error) {\n      if (error) {\n        Alerts.toast(i18next.t(\"mail.alerts.cantSendEmail\"), \"error\");\n      } else {\n        Alerts.toast(i18next.t(\"mail.alerts.emailSent\"), \"success\");\n      }\n    }); // send notification to order owner\n\n    var userId = template.order.userId;\n    var type = \"orderShipped\";\n    var prefix = Reaction.getShopPrefix();\n    var url = prefix + \"/notifications\";\n    var sms = true;\n    Meteor.call(\"notification/send\", userId, type, url, sms); // Meteor.call(\"workflow/pushOrderShipmentWorkflow\", \"coreOrderShipmentWorkflow\", \"orderShipped\", this._id);\n  },\n  \"click [data-event-action=resendNotification]\": function () {\n    var template = Template.instance();\n    Meteor.call(\"orders/sendNotification\", template.order, \"shipped\", function (error) {\n      if (error) {\n        Alerts.toast(i18next.t(\"mail.alerts.cantSendEmail\"), \"error\");\n      } else {\n        Alerts.toast(i18next.t(\"mail.alerts.emailSent\"), \"success\");\n      }\n    });\n  },\n  \"click [data-event-action=shipmentPacked]\": function () {\n    var template = Template.instance();\n    var shipment = getShippingInfo(template.order);\n    Meteor.call(\"orders/shipmentPacked\", template.order, shipment);\n  },\n  \"submit form[name=addTrackingForm]\": function (event, template) {\n    event.preventDefault();\n    event.stopPropagation();\n    var currentData = Template.currentData();\n    var order = template.order;\n    var shipment = currentData.fulfillment;\n    var tracking = event.target.trackingNumber.value;\n    Meteor.call(\"orders/updateShipmentTracking\", order, shipment, tracking, function (error) {\n      if (!error) {\n        template.orderDep.changed();\n        template.showTrackingEditForm.set(false);\n      }\n    });\n  },\n  \"click [data-event-action=editTracking]\": function (event, template) {\n    template.showTrackingEditForm.set(true);\n  }\n});\nTemplate.coreOrderShippingTracking.helpers({\n  printableLabels: function () {\n    var _Template$instance = Template.instance(),\n        order = _Template$instance.order;\n\n    var shipment = getShippingInfo(order);\n\n    if (shipment) {\n      var shippingLabelUrl = shipment.shippingLabelUrl,\n          customsLabelUrl = shipment.customsLabelUrl;\n\n      if (shippingLabelUrl || customsLabelUrl) {\n        return {\n          shippingLabelUrl: shippingLabelUrl,\n          customsLabelUrl: customsLabelUrl\n        };\n      }\n    }\n\n    return false;\n  },\n  isShipped: function () {\n    var currentData = Template.currentData();\n\n    var _Template$instance2 = Template.instance(),\n        order = _Template$instance2.order;\n\n    var shippedItems = currentData.fulfillment && currentData.fulfillment.items.every(function (shipmentItem) {\n      var fullItem = order.items.find(function (orderItem) {\n        if (orderItem._id === shipmentItem._id) {\n          return true;\n        }\n\n        return false;\n      });\n      return !fullItem.workflow.workflow.includes(\"coreOrderItemWorkflow/shipped\");\n    });\n    return shippedItems;\n  },\n  isNotCanceled: function () {\n    var currentData = Template.currentData();\n\n    var _Template$instance3 = Template.instance(),\n        order = _Template$instance3.order;\n\n    var canceledItems = currentData.fulfillment && currentData.fulfillment.items.every(function (shipmentItem) {\n      var fullItem = order.items.find(function (orderItem) {\n        if (orderItem._id === shipmentItem._id) {\n          return true;\n        }\n\n        return false;\n      });\n      return fullItem.workflow.status !== \"coreOrderItemWorkflow/canceled\";\n    });\n    return canceledItems;\n  },\n  isCompleted: function () {\n    var currentData = Template.currentData();\n\n    var _Template$instance4 = Template.instance(),\n        order = _Template$instance4.order;\n\n    var completedItems = currentData.fulfillment && currentData.fulfillment.items.every(function (shipmentItem) {\n      var fullItem = order.items.find(function (orderItem) {\n        if (orderItem._id === shipmentItem._id) {\n          return true;\n        }\n\n        return false;\n      });\n\n      if (Array.isArray(fullItem.workflow.workflow)) {\n        return fullItem.workflow.workflow.includes(\"coreOrderItemWorkflow/completed\");\n      }\n\n      return false;\n    });\n    return completedItems;\n  },\n  editTracking: function () {\n    // TODO move to a method where we loop package settings\n    // to determine if this feature is enabled.\n    // somewhere in here is where I wish this was converted to React!\n    var _Reaction$getPackageS = Reaction.getPackageSettings(\"reaction-shipping-rates\"),\n        settings = _Reaction$getPackageS.settings; // TODO: future proof by not using flatRates, but rather look for editable:true\n\n\n    if (settings && settings.flatRates.enabled === true) {\n      var _template = Template.instance();\n\n      var order = _template.order;\n      var shipment = getShippingInfo(order);\n\n      var editing = _template.showTrackingEditForm.get();\n\n      var view = false;\n\n      if (editing === true || !shipment.tracking && editing === false) {\n        view = true;\n      } // TODO modularize tracking more, editable to settings\n\n\n      if (view && shipment.shipmentMethod.carrier === \"Flat Rate\") {\n        return true;\n      }\n    }\n\n    return false;\n  },\n  order: function () {\n    return Template.instance().order;\n  },\n  shipment: function () {\n    var _Template$instance5 = Template.instance(),\n        order = _Template$instance5.order;\n\n    return getShippingInfo(order);\n  },\n  shipmentReady: function () {\n    var _Template$instance6 = Template.instance(),\n        order = _Template$instance6.order;\n\n    var shipment = getShippingInfo(order);\n    var shipmentWorkflow = shipment.workflow;\n    return shipmentWorkflow && Array.isArray(shipmentWorkflow.workflow) && shipmentWorkflow.workflow.includes(\"coreOrderWorkflow/packed\") && shipment.tracking || shipmentWorkflow && Array.isArray(shipmentWorkflow.workflow) && shipmentWorkflow.workflow.includes(\"coreOrderWorkflow/packed\");\n  }\n});","map":{"version":3,"sources":["imports/plugins/core/orders/client/templates/workflow/shippingTracking.js"],"names":["Meteor","module","watch","require","v","Tracker","ReactiveVar","Template","i18next","Reaction","Orders","getShippingInfo","coreOrderShippingTracking","onCreated","template","instance","currentData","orderDep","Dependency","showTrackingEditForm","getOrder","orderId","shipmentId","depend","findOne","autorun","order","fulfillment","_id","events","$","removeClass","call","result","error","addClass","Alerts","toast","t","timeout","shipment","userId","type","prefix","getShopPrefix","url","sms","event","preventDefault","stopPropagation","tracking","target","trackingNumber","value","changed","set","helpers","printableLabels","shippingLabelUrl","customsLabelUrl","isShipped","shippedItems","items","every","shipmentItem","fullItem","find","orderItem","workflow","includes","isNotCanceled","canceledItems","status","isCompleted","completedItems","Array","isArray","editTracking","getPackageSettings","settings","flatRates","enabled","editing","get","view","shipmentMethod","carrier","shipmentReady","shipmentWorkflow"],"mappings":"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","sourcesContent":["import { Meteor } from \"meteor/meteor\";\nimport { Tracker } from \"meteor/tracker\";\nimport { ReactiveVar } from \"meteor/reactive-var\";\nimport { Template } from \"meteor/templating\";\nimport { i18next, Reaction } from \"/client/api\";\nimport { Orders } from \"/lib/collections\";\nimport { getShippingInfo } from \"../../helpers\";\n\nTemplate.coreOrderShippingTracking.onCreated(() => {\n  const template = Template.instance();\n  const currentData = Template.currentData();\n\n  template.orderDep = new Tracker.Dependency();\n  template.showTrackingEditForm = ReactiveVar(false);\n\n  function getOrder(orderId, shipmentId) {\n    template.orderDep.depend();\n    return Orders.findOne({\n      \"_id\": orderId,\n      \"shipping._id\": shipmentId\n    });\n  }\n\n  Tracker.autorun(() => {\n    template.order = getOrder(currentData.orderId, currentData.fulfillment && currentData.fulfillment._id);\n  });\n});\n\n/**\n * coreShipmentShipped events\n *\n */\nTemplate.coreOrderShippingTracking.events({\n  \"click [data-event-action=refresh-shipping]\"() {\n    const instance = Template.instance();\n    instance.$(\"#btn-processing\").removeClass(\"hidden\");\n    const orderId = Template.instance().order._id;\n    Meteor.call(\"shipping/status/refresh\", orderId, (result) => {\n      if (result && result.error) {\n        instance.$(\"#btn-processing\").addClass(\"hidden\");\n        Alerts.toast(i18next.t(\"orderShipping.labelError\", { error: result.error }), \"error\", { timeout: 7000 });\n      }\n    });\n  },\n  \"click [data-event-action=shipmentShipped]\"() {\n    const template = Template.instance();\n    const shipment = getShippingInfo(template.order);\n    Meteor.call(\"orders/shipmentShipped\", template.order, shipment, (error) => {\n      if (error) {\n        Alerts.toast(i18next.t(\"mail.alerts.cantSendEmail\"), \"error\");\n      } else {\n        Alerts.toast(i18next.t(\"mail.alerts.emailSent\"), \"success\");\n      }\n    });\n\n    // send notification to order owner\n    const { userId } = template.order;\n    const type = \"orderShipped\";\n    const prefix = Reaction.getShopPrefix();\n    const url = `${prefix}/notifications`;\n    const sms = true;\n    Meteor.call(\"notification/send\", userId, type, url, sms);\n\n    // Meteor.call(\"workflow/pushOrderShipmentWorkflow\", \"coreOrderShipmentWorkflow\", \"orderShipped\", this._id);\n  },\n\n  \"click [data-event-action=resendNotification]\"() {\n    const template = Template.instance();\n    Meteor.call(\"orders/sendNotification\", template.order, \"shipped\", (error) => {\n      if (error) {\n        Alerts.toast(i18next.t(\"mail.alerts.cantSendEmail\"), \"error\");\n      } else {\n        Alerts.toast(i18next.t(\"mail.alerts.emailSent\"), \"success\");\n      }\n    });\n  },\n\n  \"click [data-event-action=shipmentPacked]\": () => {\n    const template = Template.instance();\n    const shipment = getShippingInfo(template.order);\n\n    Meteor.call(\"orders/shipmentPacked\", template.order, shipment);\n  },\n\n  \"submit form[name=addTrackingForm]\": (event, template) => {\n    event.preventDefault();\n    event.stopPropagation();\n\n    const currentData = Template.currentData();\n    const { order } = template;\n    const shipment = currentData.fulfillment;\n    const tracking = event.target.trackingNumber.value;\n\n    Meteor.call(\"orders/updateShipmentTracking\", order, shipment, tracking, (error) => {\n      if (!error) {\n        template.orderDep.changed();\n        template.showTrackingEditForm.set(false);\n      }\n    });\n  },\n  \"click [data-event-action=editTracking]\": (event, template) => {\n    template.showTrackingEditForm.set(true);\n  }\n});\n\nTemplate.coreOrderShippingTracking.helpers({\n  printableLabels() {\n    const { order } = Template.instance();\n    const shipment = getShippingInfo(order);\n\n    if (shipment) {\n      const { shippingLabelUrl, customsLabelUrl } = shipment;\n      if (shippingLabelUrl || customsLabelUrl) {\n        return { shippingLabelUrl, customsLabelUrl };\n      }\n    }\n\n    return false;\n  },\n  isShipped() {\n    const currentData = Template.currentData();\n    const { order } = Template.instance();\n\n    const shippedItems = currentData.fulfillment && currentData.fulfillment.items.every((shipmentItem) => {\n      const fullItem = order.items.find((orderItem) => {\n        if (orderItem._id === shipmentItem._id) {\n          return true;\n        }\n        return false;\n      });\n\n      return !fullItem.workflow.workflow.includes(\"coreOrderItemWorkflow/shipped\");\n    });\n\n    return shippedItems;\n  },\n\n  isNotCanceled() {\n    const currentData = Template.currentData();\n    const { order } = Template.instance();\n\n    const canceledItems = currentData.fulfillment && currentData.fulfillment.items.every((shipmentItem) => {\n      const fullItem = order.items.find((orderItem) => {\n        if (orderItem._id === shipmentItem._id) {\n          return true;\n        }\n        return false;\n      });\n\n      return fullItem.workflow.status !== \"coreOrderItemWorkflow/canceled\";\n    });\n\n    return canceledItems;\n  },\n\n  isCompleted() {\n    const currentData = Template.currentData();\n    const { order } = Template.instance();\n\n    const completedItems = currentData.fulfillment && currentData.fulfillment.items.every((shipmentItem) => {\n      const fullItem = order.items.find((orderItem) => {\n        if (orderItem._id === shipmentItem._id) {\n          return true;\n        }\n        return false;\n      });\n\n      if (Array.isArray(fullItem.workflow.workflow)) {\n        return fullItem.workflow.workflow.includes(\"coreOrderItemWorkflow/completed\");\n      }\n\n      return false;\n    });\n\n    return completedItems;\n  },\n\n  editTracking() {\n    // TODO move to a method where we loop package settings\n    // to determine if this feature is enabled.\n    // somewhere in here is where I wish this was converted to React!\n    const { settings } = Reaction.getPackageSettings(\"reaction-shipping-rates\");\n    // TODO: future proof by not using flatRates, but rather look for editable:true\n    if (settings && settings.flatRates.enabled === true) {\n      const template = Template.instance();\n      const { order } = template;\n      const shipment = getShippingInfo(order);\n      const editing = template.showTrackingEditForm.get();\n      let view = false;\n      if (editing === true || (!shipment.tracking && editing === false)) {\n        view = true;\n      }\n      // TODO modularize tracking more, editable to settings\n      if (view && shipment.shipmentMethod.carrier === \"Flat Rate\") {\n        return true;\n      }\n    }\n    return false;\n  },\n  order() {\n    return Template.instance().order;\n  },\n  shipment() {\n    const { order } = Template.instance();\n    return getShippingInfo(order);\n  },\n  shipmentReady() {\n    const { order } = Template.instance();\n    const shipment = getShippingInfo(order);\n    const shipmentWorkflow = shipment.workflow;\n\n    return (shipmentWorkflow && Array.isArray(shipmentWorkflow.workflow) && shipmentWorkflow.workflow.includes(\"coreOrderWorkflow/packed\") && shipment.tracking)\n      || (shipmentWorkflow && Array.isArray(shipmentWorkflow.workflow) && shipmentWorkflow.workflow.includes(\"coreOrderWorkflow/packed\"));\n  }\n});\n"]},"sourceType":"script","hash":"e2aef8d808d77428354e0ba91cbdcee607852dca"}
