{"metadata":{},"options":{"plugins":[{"key":"base$0$0","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"generateLetDeclarations":true,"enforceStrictMode":false}},{"key":"transform-meteor-dynamic-import","visitor":{"_exploded":{},"_verified":{},"CallExpression":{"enter":[null]}},"options":{}},{"key":"base$0$2","visitor":{"CallExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"MemberExpression":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true,"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"polyfill":false,"useBuiltIns":false}},{"key":"base$0$3","visitor":{"_exploded":{},"_verified":{},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]}},"options":{"loose":true}},{"key":"base$0$4","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$5","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$6","visitor":{"Program":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"allowTopLevelThis":true,"strictMode":false,"loose":true}},{"key":"base$0$1$0","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"Program":{"enter":[null],"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","throwIfNamespace":true,"useBuiltIns":false}},{"key":"base$0$1$1","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$1$2","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$1","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$2","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$3","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$4","visitor":{"VariableDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"_exploded":true,"BlockStatement":{"enter":[null]},"SwitchStatement":{"enter":[null]},"Program":{"enter":[null]},"_verified":true,"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"base$0$0$5","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"base$0$0$6","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"base$0$0$7","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"base$0$0$8","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"base$0$0$9","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$10","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$11","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]}},"options":{}},{"key":"base$0$0$12","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$13","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$14","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$15","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"base$0$0$16","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]}},"options":{}},{"key":"base$0$0$17","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$18","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$19","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"base$0$0$20","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$21","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"base$0$0$22","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$23","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"regenerator-transform","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]}},"options":{}}],"presets":[],"compact":false,"ast":true,"babelrc":false,"sourceFileName":"client/modules/i18n/currency.js","filename":"client/modules/i18n/currency.js","sourceMaps":true,"envName":"development","cwd":"/Users/estebandev/test-knowledge","passPerPreset":false,"parserOpts":{"sourceType":"module","sourceFileName":"client/modules/i18n/currency.js","plugins":["dynamicImport","classProperties","jsx","jsx","flow","asyncGenerators","objectRestSpread","objectRestSpread","flow","asyncGenerators"]},"generatorOpts":{"filename":"client/modules/i18n/currency.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"client/modules/i18n/currency.js"}},"code":"var _typeof2 = _interopRequireDefault(require(\"@babel/runtime/helpers/typeof\"));\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { \"default\": obj }; }\n\nmodule.export({\n  findCurrency: function () {\n    return findCurrency;\n  },\n  formatPriceString: function () {\n    return formatPriceString;\n  },\n  formatNumber: function () {\n    return formatNumber;\n  }\n});\nvar accounting;\nmodule.watch(require(\"accounting-js\"), {\n  \"default\": function (v) {\n    accounting = v;\n  }\n}, 0);\nvar Meteor;\nmodule.watch(require(\"meteor/meteor\"), {\n  Meteor: function (v) {\n    Meteor = v;\n  }\n}, 1);\nvar Reaction, Logger;\nmodule.watch(require(\"../../api\"), {\n  Reaction: function (v) {\n    Reaction = v;\n  },\n  Logger: function (v) {\n    Logger = v;\n  }\n}, 2);\nvar Shops, Accounts;\nmodule.watch(require(\"../../../lib/collections\"), {\n  Shops: function (v) {\n    Shops = v;\n  },\n  Accounts: function (v) {\n    Accounts = v;\n  }\n}, 3);\nvar currencyDep;\nmodule.watch(require(\"./main\"), {\n  currencyDep: function (v) {\n    currencyDep = v;\n  }\n}, 4);\n\nfunction findCurrency(defaultCurrency, useDefaultShopCurrency) {\n  var shop = Shops.findOne(Reaction.getPrimaryShopId(), {\n    fields: {\n      currencies: 1,\n      currency: 1\n    }\n  });\n  var shopCurrency = shop && shop.currency || \"USD\";\n  var user = Accounts.findOne({\n    _id: Meteor.userId()\n  });\n  var profileCurrency = user && user.profile && user.profile.currency;\n\n  if ((0, _typeof2.default)(shop) === \"object\" && shop.currencies && profileCurrency) {\n    var _userCurrency = {};\n\n    if (shop.currencies[profileCurrency]) {\n      if (useDefaultShopCurrency) {\n        _userCurrency = shop.currencies[shop.currency];\n        _userCurrency.exchangeRate = 1;\n      } else {\n        _userCurrency = shop.currencies[profileCurrency];\n        _userCurrency.exchangeRate = shop.currencies[profileCurrency].rate;\n      }\n    }\n\n    return _userCurrency;\n  }\n\n  return shop.currencies[shopCurrency];\n}\n\nfunction formatPriceString(formatPrice, useDefaultShopCurrency) {\n  var defaultShopCurrency = useDefaultShopCurrency; // in case useDefaultShopCurrency is a Spacebars.kw we have this check\n\n  if ((0, _typeof2.default)(useDefaultShopCurrency) === \"object\" || !useDefaultShopCurrency) {\n    defaultShopCurrency = false;\n  }\n\n  currencyDep.depend();\n  var locale = Reaction.Locale.get();\n\n  if ((0, _typeof2.default)(locale) !== \"object\" || (0, _typeof2.default)(locale.currency) !== \"object\") {\n    // locale not yet loaded, so we don\"t need to return anything.\n    return false;\n  }\n\n  if (typeof formatPrice !== \"string\" && typeof formatPrice !== \"number\") {\n    return false;\n  } // get user currency instead of locale currency\n\n\n  var userCurrency = findCurrency(locale.currency, defaultShopCurrency); // for the cases then we have only one price. It is a number.\n\n  var currentPrice = formatPrice.toString();\n  var price = 0;\n  var prices = currentPrice.indexOf(\" - \") >= 0 ? currentPrice.split(\" - \") : [currentPrice]; // basic \"for\" is faster then \"for ...of\" for arrays. We need more speed here\n\n  var len = prices.length;\n\n  for (var i = 0; i < len; i += 1) {\n    var originalPrice = prices[i];\n\n    try {\n      // we know the locale, but we don\"t know exchange rate. In that case we\n      // should return to default shop currency\n      if (typeof userCurrency.rate !== \"number\") {\n        throw new Meteor.Error(\"invalid-exchange-rate\", \"Exchange rate is invalid\");\n      } // Only convert for non-admin view.\n\n\n      if (!defaultShopCurrency) {\n        prices[i] *= userCurrency.rate;\n      }\n\n      price = _formatPrice(price, originalPrice, prices[i], currentPrice, userCurrency, i, len);\n    } catch (error) {\n      Logger.debug(\"currency error, fallback to shop currency\");\n      price = _formatPrice(price, originalPrice, prices[i], currentPrice, locale.shopCurrency, i, len);\n    }\n  }\n\n  return price;\n}\n\nfunction formatNumber(currentPrice) {\n  var locale = Reaction.Locale.get();\n  var price = currentPrice;\n  var format = Object.assign({}, locale.currency, {\n    format: \"%v\"\n  });\n  var shopFormat = Object.assign({}, locale.shopCurrency, {\n    format: \"%v\"\n  });\n\n  if ((0, _typeof2.default)(locale.currency) === \"object\" && locale.currency.rate) {\n    price = currentPrice * locale.currency.rate;\n    return accounting.formatMoney(price, format);\n  }\n\n  Logger.debug(\"currency error, fallback to shop currency\");\n  return accounting.formatMoney(currentPrice, shopFormat);\n}\n\n/**\n * _formatPrice\n * private function for formatting locale currency\n * @private\n * @param  {Number} price         price\n * @param  {Number} originalPrice originalPrice\n * @param  {Number} actualPrice   actualPrice\n * @param  {Number} currentPrice  currentPrice\n * @param  {Number} currency      currency\n * @param  {Number} pos           position\n * @param  {Number} len           length\n * @return {Number}               formatted price\n */\nfunction _formatPrice(price, originalPrice, actualPrice, currentPrice, currency, pos, len) {\n  // this checking for locale.shopCurrency mostly\n  if ((0, _typeof2.default)(currency) !== \"object\") {\n    return false;\n  }\n\n  var adjustedPrice = actualPrice;\n  var formattedPrice; // Precision is mis-used in accounting js. Scale is the propery term for number\n  // of decimal places. Let's adjust it here so accounting.js does not break.\n\n  if (currency.scale !== undefined) {\n    currency.precision = currency.scale;\n  } // If there are no decimal places, in the case of the Japanese Yen, we adjust it here.\n\n\n  if (currency.scale === 0) {\n    adjustedPrice = actualPrice * 100;\n  } // @param {string} currency.where: If it presents - in situation then two\n  // prices in string, currency sign will be placed just outside the right price.\n  // For now it should be manually added to fixtures shop data.\n\n\n  if (typeof currency.where === \"string\" && currency.where === \"right\" && len > 1 && pos === 0) {\n    var modifiedCurrency = Object.assign({}, currency, {\n      symbol: \"\"\n    });\n    formattedPrice = accounting.formatMoney(adjustedPrice, modifiedCurrency);\n  } else {\n    // accounting api: http://openexchangerates.github.io/accounting.js/\n    formattedPrice = accounting.formatMoney(adjustedPrice, currency);\n  }\n\n  return price === 0 ? currentPrice.replace(originalPrice, formattedPrice) : price.replace(originalPrice, formattedPrice);\n}","map":{"version":3,"sources":["client/modules/i18n/currency.js"],"names":["module","export","findCurrency","formatPriceString","formatNumber","accounting","watch","require","v","Meteor","Reaction","Logger","Shops","Accounts","currencyDep","defaultCurrency","useDefaultShopCurrency","shop","findOne","getPrimaryShopId","fields","currencies","currency","shopCurrency","user","_id","userId","profileCurrency","profile","userCurrency","exchangeRate","rate","formatPrice","defaultShopCurrency","depend","locale","Locale","get","currentPrice","toString","price","prices","indexOf","split","len","length","i","originalPrice","Error","_formatPrice","error","debug","format","Object","assign","shopFormat","formatMoney","actualPrice","pos","adjustedPrice","formattedPrice","scale","undefined","precision","where","modifiedCurrency","symbol","replace"],"mappings":"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","sourcesContent":["import accounting from \"accounting-js\";\nimport { Meteor } from \"meteor/meteor\";\nimport { Reaction, Logger } from \"/client/api\";\nimport { Shops, Accounts } from \"/lib/collections\";\nimport { currencyDep } from \"./main\";\n\n/**\n * @name findCurrency\n * @summary Private function for returning user currency\n * @private\n * @param {Object}  defaultCurrency    The default currency\n * @param {Boolean} useDefaultShopCurrency - flag for displaying shop's currency in Admin view of PDP\n * @return {Object}  user currency or shop currency if none is found\n */\nexport function findCurrency(defaultCurrency, useDefaultShopCurrency) {\n  const shop = Shops.findOne(Reaction.getPrimaryShopId(), {\n    fields: {\n      currencies: 1,\n      currency: 1\n    }\n  });\n\n  const shopCurrency = (shop && shop.currency) || \"USD\";\n  const user = Accounts.findOne({\n    _id: Meteor.userId()\n  });\n  const profileCurrency = user && user.profile && user.profile.currency;\n  if (typeof shop === \"object\" && shop.currencies && profileCurrency) {\n    let userCurrency = {};\n    if (shop.currencies[profileCurrency]) {\n      if (useDefaultShopCurrency) {\n        userCurrency = shop.currencies[shop.currency];\n        userCurrency.exchangeRate = 1;\n      } else {\n        userCurrency = shop.currencies[profileCurrency];\n        userCurrency.exchangeRate = shop.currencies[profileCurrency].rate;\n      }\n    }\n    return userCurrency;\n  }\n  return shop.currencies[shopCurrency];\n}\n\n/**\n * @name formatPriceString\n * @summary Return shop/locale specific formatted price. Also accepts a range formatted with \" - \".\n * @memberof i18n\n * @method\n * @param {String} formatPrice - currentPrice or \"xx.xx - xx.xx\" formatted String\n * @param {Boolean} useDefaultShopCurrency - flag for displaying shop's currency in Admin view of PDP\n * @return {String} returns locale formatted and exchange rate converted values\n */\nexport function formatPriceString(formatPrice, useDefaultShopCurrency) {\n  let defaultShopCurrency = useDefaultShopCurrency;\n\n  // in case useDefaultShopCurrency is a Spacebars.kw we have this check\n  if (typeof useDefaultShopCurrency === \"object\" || !useDefaultShopCurrency) {\n    defaultShopCurrency = false;\n  }\n\n  currencyDep.depend();\n  const locale = Reaction.Locale.get();\n\n  if (typeof locale !== \"object\" || typeof locale.currency !== \"object\") {\n    // locale not yet loaded, so we don\"t need to return anything.\n    return false;\n  }\n\n  if (typeof formatPrice !== \"string\" && typeof formatPrice !== \"number\") {\n    return false;\n  }\n\n  // get user currency instead of locale currency\n  const userCurrency = findCurrency(locale.currency, defaultShopCurrency);\n\n  // for the cases then we have only one price. It is a number.\n  const currentPrice = formatPrice.toString();\n  let price = 0;\n  const prices = currentPrice.indexOf(\" - \") >= 0 ?\n    currentPrice.split(\" - \") : [currentPrice];\n\n  // basic \"for\" is faster then \"for ...of\" for arrays. We need more speed here\n  const len = prices.length;\n  for (let i = 0; i < len; i += 1) {\n    const originalPrice = prices[i];\n    try {\n      // we know the locale, but we don\"t know exchange rate. In that case we\n      // should return to default shop currency\n      if (typeof userCurrency.rate !== \"number\") {\n        throw new Meteor.Error(\"invalid-exchange-rate\", \"Exchange rate is invalid\");\n      }\n      // Only convert for non-admin view.\n      if (!defaultShopCurrency) {\n        prices[i] *= userCurrency.rate;\n      }\n\n      price = _formatPrice(\n        price, originalPrice, prices[i],\n        currentPrice, userCurrency, i, len\n      );\n    } catch (error) {\n      Logger.debug(\"currency error, fallback to shop currency\");\n      price = _formatPrice(\n        price, originalPrice, prices[i],\n        currentPrice, locale.shopCurrency, i, len\n      );\n    }\n  }\n  return price;\n}\n\n/**\n * @name formatNumber\n * @memberof i18n\n * @method\n * @param {String} currentPrice - current Price\n * @return {String} return formatted number\n */\nexport function formatNumber(currentPrice) {\n  const locale = Reaction.Locale.get();\n  let price = currentPrice;\n  const format = Object.assign({}, locale.currency, {\n    format: \"%v\"\n  });\n  const shopFormat = Object.assign({}, locale.shopCurrency, {\n    format: \"%v\"\n  });\n\n  if (typeof locale.currency === \"object\" && locale.currency.rate) {\n    price = currentPrice * locale.currency.rate;\n    return accounting.formatMoney(price, format);\n  }\n\n  Logger.debug(\"currency error, fallback to shop currency\");\n  return accounting.formatMoney(currentPrice, shopFormat);\n}\n\n/**\n * _formatPrice\n * private function for formatting locale currency\n * @private\n * @param  {Number} price         price\n * @param  {Number} originalPrice originalPrice\n * @param  {Number} actualPrice   actualPrice\n * @param  {Number} currentPrice  currentPrice\n * @param  {Number} currency      currency\n * @param  {Number} pos           position\n * @param  {Number} len           length\n * @return {Number}               formatted price\n */\nfunction _formatPrice(\n  price, originalPrice, actualPrice, currentPrice, currency,\n  pos, len\n) {\n  // this checking for locale.shopCurrency mostly\n  if (typeof currency !== \"object\") {\n    return false;\n  }\n\n  let adjustedPrice = actualPrice;\n  let formattedPrice;\n\n  // Precision is mis-used in accounting js. Scale is the propery term for number\n  // of decimal places. Let's adjust it here so accounting.js does not break.\n  if (currency.scale !== undefined) {\n    currency.precision = currency.scale;\n  }\n\n  // If there are no decimal places, in the case of the Japanese Yen, we adjust it here.\n  if (currency.scale === 0) {\n    adjustedPrice = actualPrice * 100;\n  }\n\n  // @param {string} currency.where: If it presents - in situation then two\n  // prices in string, currency sign will be placed just outside the right price.\n  // For now it should be manually added to fixtures shop data.\n  if (typeof currency.where === \"string\" && currency.where === \"right\" &&\n    len > 1 && pos === 0) {\n    const modifiedCurrency = Object.assign({}, currency, {\n      symbol: \"\"\n    });\n    formattedPrice = accounting.formatMoney(adjustedPrice, modifiedCurrency);\n  } else {\n    // accounting api: http://openexchangerates.github.io/accounting.js/\n    formattedPrice = accounting.formatMoney(adjustedPrice, currency);\n  }\n\n  return price === 0 ? currentPrice.replace(originalPrice, formattedPrice) : price.replace(originalPrice, formattedPrice);\n}\n"]},"sourceType":"script","hash":"6f05697aa88dcb06542c5898068f879769c8c718"}
