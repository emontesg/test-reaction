{"metadata":{},"options":{"plugins":[{"key":"base$0$0","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"generateLetDeclarations":true,"enforceStrictMode":false}},{"key":"transform-meteor-dynamic-import","visitor":{"_exploded":{},"_verified":{},"CallExpression":{"enter":[null]}},"options":{}},{"key":"base$0$2","visitor":{"CallExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"MemberExpression":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true,"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"polyfill":false,"useBuiltIns":false}},{"key":"base$0$3","visitor":{"_exploded":{},"_verified":{},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]}},"options":{"loose":true}},{"key":"base$0$4","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$5","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$6","visitor":{"Program":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"allowTopLevelThis":true,"strictMode":false,"loose":true}},{"key":"base$0$1$0","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"Program":{"enter":[null],"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","throwIfNamespace":true,"useBuiltIns":false}},{"key":"base$0$1$1","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$1$2","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$1","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$2","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$3","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$4","visitor":{"VariableDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"_exploded":true,"BlockStatement":{"enter":[null]},"SwitchStatement":{"enter":[null]},"Program":{"enter":[null]},"_verified":true,"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"base$0$0$5","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"base$0$0$6","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"base$0$0$7","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"base$0$0$8","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"base$0$0$9","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$10","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$11","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]}},"options":{}},{"key":"base$0$0$12","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$13","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$14","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$15","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"base$0$0$16","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]}},"options":{}},{"key":"base$0$0$17","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$18","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$19","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"base$0$0$20","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$21","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"base$0$0$22","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$23","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"regenerator-transform","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]}},"options":{}}],"presets":[],"compact":false,"ast":true,"babelrc":false,"sourceFileName":"client/modules/core/main.js","filename":"client/modules/core/main.js","sourceMaps":true,"envName":"development","cwd":"/Users/estebandev/test-knowledge","passPerPreset":false,"parserOpts":{"sourceType":"module","sourceFileName":"client/modules/core/main.js","plugins":["dynamicImport","classProperties","jsx","jsx","flow","asyncGenerators","objectRestSpread","objectRestSpread","flow","asyncGenerators"]},"generatorOpts":{"filename":"client/modules/core/main.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"client/modules/core/main.js"}},"code":"var _objectSpread2 = _interopRequireDefault(require(\"@babel/runtime/helpers/objectSpread\"));\n\nvar _typeof2 = _interopRequireDefault(require(\"@babel/runtime/helpers/typeof\"));\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { \"default\": obj }; }\n\nfunction _slicedToArray(arr, i) { return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _nonIterableRest(); }\n\nfunction _nonIterableRest() { throw new TypeError(\"Invalid attempt to destructure non-iterable instance\"); }\n\nfunction _iterableToArrayLimit(arr, i) { var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i[\"return\"] != null) _i[\"return\"](); } finally { if (_d) throw _e; } } return _arr; }\n\nfunction _arrayWithHoles(arr) { if (Array.isArray(arr)) return arr; }\n\nmodule.export({\n  userPrefs: function () {\n    return userPrefs;\n  }\n});\n\nvar _find;\n\nmodule.watch(require(\"lodash/find\"), {\n  \"default\": function (v) {\n    _find = v;\n  }\n}, 0);\n\nvar _difference;\n\nmodule.watch(require(\"lodash/difference\"), {\n  \"default\": function (v) {\n    _difference = v;\n  }\n}, 1);\n\nvar _uniq;\n\nmodule.watch(require(\"lodash/uniq\"), {\n  \"default\": function (v) {\n    _uniq = v;\n  }\n}, 2);\nvar store;\nmodule.watch(require(\"store\"), {\n  \"default\": function (v) {\n    store = v;\n  }\n}, 3);\nvar MeteorAccounts;\nmodule.watch(require(\"meteor/accounts-base\"), {\n  Accounts: function (v) {\n    MeteorAccounts = v;\n  }\n}, 4);\nvar Meteor;\nmodule.watch(require(\"meteor/meteor\"), {\n  Meteor: function (v) {\n    Meteor = v;\n  }\n}, 5);\nvar Session;\nmodule.watch(require(\"meteor/session\"), {\n  Session: function (v) {\n    Session = v;\n  }\n}, 6);\nvar check;\nmodule.watch(require(\"meteor/check\"), {\n  check: function (v) {\n    check = v;\n  }\n}, 7);\nvar Tracker;\nmodule.watch(require(\"meteor/tracker\"), {\n  Tracker: function (v) {\n    Tracker = v;\n  }\n}, 8);\nvar ReactiveVar;\nmodule.watch(require(\"meteor/reactive-var\"), {\n  ReactiveVar: function (v) {\n    ReactiveVar = v;\n  }\n}, 9);\nvar ReactiveDict;\nmodule.watch(require(\"meteor/reactive-dict\"), {\n  ReactiveDict: function (v) {\n    ReactiveDict = v;\n  }\n}, 10);\nvar Roles;\nmodule.watch(require(\"meteor/alanning:roles\"), {\n  Roles: function (v) {\n    Roles = v;\n  }\n}, 11);\nvar Logger;\nmodule.watch(require(\"../logger\"), {\n  \"default\": function (v) {\n    Logger = v;\n  }\n}, 12);\nvar Countries;\nmodule.watch(require(\"../../collections\"), {\n  Countries: function (v) {\n    Countries = v;\n  }\n}, 13);\nvar localeDep;\nmodule.watch(require(\"../i18n\"), {\n  localeDep: function (v) {\n    localeDep = v;\n  }\n}, 14);\nvar Packages, Shops, Accounts;\nmodule.watch(require(\"../../../lib/collections\"), {\n  Packages: function (v) {\n    Packages = v;\n  },\n  Shops: function (v) {\n    Shops = v;\n  },\n  Accounts: function (v) {\n    Accounts = v;\n  }\n}, 15);\nvar Router;\nmodule.watch(require(\"../router\"), {\n  Router: function (v) {\n    Router = v;\n  }\n}, 16);\n// Global, private state object for client side\n// This is placed outside the main object to make it a private variable.\n// access using `Reaction.state`\nvar reactionState = new ReactiveDict();\nvar userPrefs = new ReactiveVar(undefined, function (val, newVal) {\n  return JSON.stringify(val) === JSON.stringify(newVal);\n});\nvar deps = new Map();\n/**\n * Reaction namespace\n * Global reaction shop permissions methods and shop initialization\n */\n\nmodule.exportDefault({\n  _shopId: new ReactiveVar(null),\n  // The active shop\n  _primaryShopId: new ReactiveVar(null),\n  // The first shop created\n  marketplace: {\n    _ready: false\n  },\n  // Marketplace Settings\n  Locale: new ReactiveVar({}),\n  init: function () {\n    var _this = this;\n\n    Tracker.autorun(function () {\n      // marketplaceSettings come over on the PrimaryShopPackages subscription\n      if (_this.Subscriptions.PrimaryShopPackages.ready()) {\n        if (!_this.marketplace._ready) {\n          var marketplacePkgSettings = _this.getMarketplaceSettings();\n\n          if (marketplacePkgSettings && marketplacePkgSettings.public) {\n            _this.marketplace._ready = true;\n            _this.marketplace = marketplacePkgSettings.public;\n            _this.marketplace.enabled = true;\n          }\n        }\n      }\n    }); // Listen for the primary shop subscription and set accordingly\n\n    Tracker.autorun(function () {\n      var shop;\n\n      if (_this.Subscriptions.PrimaryShop.ready()) {\n        // There should only ever be one \"primary\" shop\n        shop = Shops.findOne({\n          shopType: \"primary\"\n        });\n\n        if (shop) {\n          _this.primaryShopId = shop._id;\n          _this.primaryShopName = shop.name; // We'll initialize locale and currency for the primary shop unless\n          // marketplace settings exist and merchantLocale is set to true\n\n          if (_this.marketplace.merchantLocale !== true) {\n            // initialize local client Countries collection\n            if (!Countries.findOne()) {\n              createCountryCollection(shop.locales.countries);\n            }\n\n            var locale = _this.Locale.get() || {}; // fix for https://github.com/reactioncommerce/reaction/issues/248\n            // we need to keep an eye for rates changes\n\n            if ((0, _typeof2.default)(locale.locale) === \"object\" && (0, _typeof2.default)(locale.currency) === \"object\" && typeof locale.locale.currency === \"string\") {\n              var localeCurrency = locale.locale.currency.split(\",\")[0];\n\n              if ((0, _typeof2.default)(shop.currencies[localeCurrency]) === \"object\") {\n                if (typeof shop.currencies[localeCurrency].rate === \"number\") {\n                  locale.currency.rate = shop.currencies[localeCurrency].rate;\n                  localeDep.changed();\n                }\n              }\n            } // we are looking for a shopCurrency changes here\n\n\n            if ((0, _typeof2.default)(locale.shopCurrency) === \"object\") {\n              locale.shopCurrency = shop.currencies[shop.currency];\n              localeDep.changed();\n            }\n          }\n        }\n      }\n    }); // Listen for active shop change\n\n    return Tracker.autorun(function () {\n      var shop;\n\n      if (_this.Subscriptions.MerchantShops.ready()) {\n        // get domain (e.g localhost) from absolute url (e.g http://localhost:3000/)\n        var _Meteor$absoluteUrl$s = Meteor.absoluteUrl().split(\"/\"),\n            _Meteor$absoluteUrl$s2 = _slicedToArray(_Meteor$absoluteUrl$s, 3),\n            host = _Meteor$absoluteUrl$s2[2];\n\n        var _host$split = host.split(\":\"),\n            _host$split2 = _slicedToArray(_host$split, 1),\n            domain = _host$split2[0]; // if we don't have an active shopId, try to retreive it from the userPreferences object\n        // and set the shop from the storedShopId\n\n\n        if (!_this.shopId) {\n          var storedShopId = _this.getUserPreferences(\"reaction\", \"activeShopId\");\n\n          if (storedShopId) {\n            shop = Shops.findOne({\n              _id: storedShopId\n            });\n          } else {\n            shop = Shops.findOne({\n              domains: domain\n            });\n          }\n        }\n\n        if (shop) {\n          // Only set shopId if it hasn't been set yet\n          if (!_this.shopId) {\n            _this.shopId = shop._id;\n            _this.shopName = shop.name;\n          } // We only use the active shop to setup locale if marketplace settings\n          // are enabled and merchantLocale is set to true\n\n\n          if (_this.marketplace.merchantLocale === true) {\n            // initialize local client Countries collection\n            if (!Countries.findOne()) {\n              createCountryCollection(shop.locales.countries);\n            }\n\n            var locale = _this.Locale.get() || {}; // fix for https://github.com/reactioncommerce/reaction/issues/248\n            // we need to keep an eye for rates changes\n\n            if ((0, _typeof2.default)(locale.locale) === \"object\" && (0, _typeof2.default)(locale.currency) === \"object\" && typeof locale.locale.currency === \"string\") {\n              var localeCurrency = locale.locale.currency.split(\",\")[0];\n\n              if ((0, _typeof2.default)(shop.currencies[localeCurrency]) === \"object\") {\n                if (typeof shop.currencies[localeCurrency].rate === \"number\") {\n                  locale.currency.rate = shop.currencies[localeCurrency].rate;\n                  localeDep.changed();\n                }\n              }\n            } // we are looking for a shopCurrency changes here\n\n\n            if ((0, _typeof2.default)(locale.shopCurrency) === \"object\") {\n              locale.shopCurrency = shop.currencies[shop.currency];\n              localeDep.changed();\n            }\n          }\n\n          return _this;\n        }\n      }\n    });\n  },\n\n  // Return global \"reactionState\" Reactive Dict\n  get state() {\n    return reactionState;\n  },\n\n  /**\n   * hasPermission - client\n   * client permissions checks\n   * hasPermission exists on both the server and the client.\n   *\n   * @param {String | Array} checkPermissions -String or Array of permissions if empty, defaults to \"admin, owner\"\n   * @param {String} checkUserId - userId, defaults to Meteor.userId()\n   * @param {String} checkGroup group - default to shopId\n   * @return {Boolean} Boolean - true if has permission\n   */\n  hasPermission: function (checkPermissions, checkUserId, checkGroup) {\n    var group; // default group to the shop or global if shop isn't defined for some reason.\n\n    if (checkGroup !== undefined && typeof checkGroup === \"string\") {\n      group = checkGroup;\n    } else {\n      group = this.getShopId() || Roles.GLOBAL_GROUP;\n    }\n\n    var permissions = [\"owner\"];\n    var id = \"\";\n    var userId = checkUserId || Meteor.userId(); //\n    // local roleCheck function\n    // is the bulk of the logic\n    // called out a userId is validated.\n    //\n\n    function roleCheck() {\n      // permissions can be either a string or an array\n      // we'll force it into an array and use that\n      if (checkPermissions === undefined) {\n        permissions = [\"owner\"];\n      } else if (typeof checkPermissions === \"string\") {\n        permissions = [checkPermissions];\n      } else {\n        permissions = checkPermissions;\n      } // if the user has owner permissions we'll always check if those roles are enough\n      // By adding the \"owner\" role to the permissions list, we are making hasPermission always return\n      // true for \"owners\". This gives owners global access.\n      // TODO: Review this way of granting global access for owners\n\n\n      permissions.push(\"owner\");\n      permissions = _uniq(permissions); //\n      // return if user has permissions in the group\n      //\n\n      if (Roles.userIsInRole(userId, permissions, group)) {\n        return true;\n      } // global roles check\n      // TODO: Review this commented out code\n\n      /*\n       const sellerShopPermissions = Roles.getGroupsForUser(userId, \"admin\");\n      // we're looking for seller permissions.\n      if (sellerShopPermissions) {\n        // loop through shops roles and check permissions\n        for (const key in sellerShopPermissions) {\n          if (key) {\n            const shop = sellerShopPermissions[key];\n            if (Roles.userIsInRole(userId, permissions, shop)) {\n              return true;\n            }\n          }\n        }\n      }*/\n      // no specific permissions found returning false\n\n\n      return false;\n    } //\n    // check if a user id has been found\n    // in line 156 setTimeout\n    //\n\n\n    function validateUserId() {\n      if (Meteor.userId()) {\n        Meteor.clearTimeout(id);\n        Router.reload();\n        return roleCheck();\n      }\n\n      return false;\n    } //\n    // actual logic block to check permissions\n    // we'll bypass unecessary checks during\n    // a user logging, as we'll check again\n    // when everything is ready\n    //\n\n\n    var loggingIn;\n    Tracker.nonreactive(function () {\n      loggingIn = MeteorAccounts.loggingIn();\n    });\n\n    if (loggingIn === false) {\n      //\n      // this userId check happens because when logout\n      // occurs it takes a few cycles for a new anonymous user\n      // to get created and during this time the user has no\n      // permission, not even guest permissions so we\n      // need to wait and reload the routes. This\n      // mainly affects the logout from dashboard pages\n      //\n      if (!userId) {\n        id = Meteor.setTimeout(validateUserId, 5000);\n      } else {\n        return roleCheck();\n      }\n    } // return false to be safe\n\n\n    return false;\n  },\n\n  /**\n   * hasDashboardAccessForAnyShop - client\n   * client permission check for any \"owner\", \"admin\", or \"dashboard\" permissions for any shop.\n   *\n   * @todo This could be faster with a dedicated hasAdminDashboard boolean on the user object\n   * @param { Object } options - options object that can be passed a user and/or a set of permissions\n   * @return {Boolean} Boolean - true if has dashboard access for any shop\n   */\n  hasDashboardAccessForAnyShop: function () {\n    var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {\n      user: Meteor.user(),\n      permissions: [\"owner\", \"admin\", \"dashboard\"]\n    };\n    var user = options.user,\n        permissions = options.permissions;\n\n    if (!user || !user.roles) {\n      return false;\n    } // Nested find that determines if a user has any of the permissions\n    // specified in the `permissions` array for any shop\n\n\n    var hasPermissions = Object.keys(user.roles).find(function (shopId) {\n      return user.roles[shopId].find(function (role) {\n        return permissions.find(function (permission) {\n          return permission === role;\n        });\n      });\n    }); // Find returns undefined if nothing is found.\n    // This will return true if permissions are found, false otherwise\n\n    return typeof hasPermissions !== \"undefined\";\n  },\n\n  /**\n   * hasDashboardAccessForAnyShop - client\n   * @summary - client permission check for any \"owner\", \"admin\", or \"dashboard\" permissions for more than one shop.\n   * @return {Boolean} Boolean - true if has dashboard access for more than one shop\n   */\n  hasDashboardAccessForMultipleShops: function () {\n    var adminShopIds = this.getShopsForUser([\"owner\", \"admin\", \"dashboard\"]);\n    return Array.isArray(adminShopIds) && adminShopIds.length > 1;\n  },\n  hasOwnerAccess: function () {\n    var ownerPermissions = [\"owner\"];\n    return this.hasPermission(ownerPermissions);\n  },\n\n  /**\n   * Checks to see if the user has admin permissions. If a shopId is optionally\n   * passed in, we check for that shopId, otherwise we check against the default\n   * @method hasAdminAccess\n   * @param  {string} [shopId] Optional shopId to check access against\n   * @return {Boolean} true if the user has admin or owner permission,\n   *                   otherwise false\n   */\n  hasAdminAccess: function (shopId) {\n    var adminPermissions = [\"owner\", \"admin\"];\n\n    if (shopId) {\n      return this.hasPermission(adminPermissions, Meteor.userId(), shopId);\n    }\n\n    return this.hasPermission(adminPermissions);\n  },\n  hasDashboardAccess: function () {\n    var dashboardPermissions = [\"owner\", \"admin\", \"dashboard\"];\n    return this.hasPermission(dashboardPermissions);\n  },\n  hasShopSwitcherAccess: function () {\n    return this.hasDashboardAccessForMultipleShops();\n  },\n  getSellerShopId: function () {\n    var userId = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : Meteor.userId();\n    var noFallback = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;\n\n    if (userId) {\n      var _group = Roles.getGroupsForUser(userId, \"admin\")[0];\n\n      if (_group) {\n        return _group;\n      }\n    }\n\n    if (noFallback) {\n      return false;\n    }\n\n    return this.getShopId();\n  },\n  getUserPreferences: function (packageName, preference, defaultValue) {\n    getDep(packageName + \".\" + preference).depend();\n\n    if (Meteor.user()) {\n      var packageSettings = store.get(packageName); // packageSettings[preference] should not be undefined or null.\n\n      if (packageSettings && typeof packageSettings[preference] !== \"undefined\" && packageSettings[preference] !== null) {\n        return packageSettings[preference];\n      }\n    }\n\n    return defaultValue || undefined;\n  },\n  setUserPreferences: function (packageName, preference, value) {\n    getDep(packageName + \".\" + preference).changed(); // User preferences are not stored in Meteor.user().profile\n    // to prevent all autorun() with dependency on Meteor.user() to run again.\n\n    if (Meteor.user()) {\n      // \"reaction\" package settings should be synced to\n      // the Accounts collection.\n      var syncedPackages = [\"reaction\"];\n\n      if (syncedPackages.indexOf(packageName) > -1) {\n        var _$set;\n\n        Accounts.update(Meteor.userId(), {\n          $set: (_$set = {}, _$set[\"profile.preferences.\" + packageName + \".\" + preference] = value, _$set)\n        });\n      }\n    }\n\n    var packageSettings = store.get(packageName) || {};\n    packageSettings[preference] = value;\n    return store.set(packageName, packageSettings);\n  },\n  updateUserPreferences: function (packageName, preference, values) {\n    var currentPreference = this.getUserPreferences(packageName, preference, {});\n    return this.setUserPreferences(packageName, preference, (0, _objectSpread2.default)({}, currentPreference, values));\n  },\n\n  // primaryShopId is the first created shop. In a marketplace setting it's\n  // the shop that controls the marketplace and can see all other shops.\n  get primaryShopId() {\n    return this._primaryShopId.get();\n  },\n\n  set primaryShopId(shopId) {\n    this._primaryShopId.set(shopId);\n  },\n\n  getPrimaryShopId: function () {\n    return this.primaryShopId;\n  },\n  getPrimaryShopName: function () {\n    var shopId = this.getPrimaryShopId();\n    var shop = Shops.findOne({\n      _id: shopId\n    });\n\n    if (shop && shop.name) {\n      return shop.name;\n    } // If we can't find the primaryShop return an empty string\n\n\n    return \"\";\n  },\n  // Primary Shop should probably not have a prefix (or should it be /shop?)\n  getPrimaryShopPrefix: function () {\n    return \"/\" + this.getSlug(this.getPrimaryShopName().toLowerCase());\n  },\n  getPrimaryShopSettings: function () {\n    var settings = Packages.findOne({\n      name: \"core\",\n      shopId: this.getPrimaryShopId()\n    }) || {};\n    return settings.settings || {};\n  },\n  getPrimaryShopCurrency: function () {\n    var shop = Shops.findOne({\n      _id: this.getPrimaryShopId()\n    });\n    return shop && shop.currency || \"USD\";\n  },\n\n  // shopId refers to the active shop. For most shoppers this will be the same\n  // as the primary shop, but for administrators this will usually be the shop\n  // they administer.\n  get shopId() {\n    return this._shopId.get();\n  },\n\n  getShopId: function () {\n    return this.shopId || this.getUserPreferences(\"reaction\", \"activeShopId\");\n  },\n\n  set shopId(id) {\n    this._shopId.set(id);\n  },\n\n  setShopId: function (id) {\n    if (!id || this.shopId === id) {\n      return;\n    }\n\n    this.shopId = id;\n    this.setUserPreferences(\"reaction\", \"activeShopId\", id);\n    Meteor.call(\"shop/resetShopId\");\n  },\n\n  /**\n   * getShopName\n   * @summary gets name of shop by provided shopId, or current active shop if shopId is not provided\n   * @param {String} providedShopID - shopId of shop to return name of\n   * @return {String} - shop name\n   */\n  getShopName: function (providedShopId) {\n    var shopId = providedShopId || this.getShopId();\n    var shop = Shops.findOne({\n      _id: shopId\n    });\n    return shop && shop.name;\n  },\n  getShopPrefix: function () {\n    var shopName = this.getShopName();\n\n    if (shopName) {\n      return Router.pathFor(\"index\", {\n        hash: {\n          shopSlug: this.getSlug(shopName.toLowerCase())\n        }\n      });\n    }\n  },\n  getShopSettings: function () {\n    var settings = Packages.findOne({\n      name: \"core\",\n      shopId: this.shopId\n    }) || {};\n    return settings.settings || {};\n  },\n  getShopCurrency: function () {\n    var shop = Shops.findOne({\n      _id: this.shopId\n    });\n    return shop && shop.currency || \"USD\";\n  },\n  isPreview: function () {\n    var viewAs = this.getUserPreferences(\"reaction-dashboard\", \"viewAs\", \"administrator\");\n\n    if (viewAs === \"customer\") {\n      return true;\n    }\n\n    return false;\n  },\n  getPackageSettings: function (name) {\n    var shopId = this.getShopId();\n    var query = {\n      name: name\n    };\n\n    if (shopId) {\n      query.shopId = shopId;\n    }\n\n    return Packages.findOne(query);\n  },\n  getPackageSettingsWithOptions: function (options) {\n    var query = options;\n    return Packages.findOne(query);\n  },\n  allowGuestCheckout: function () {\n    var settings = this.getShopSettings(); // we can disable in admin, let's check.\n\n    return !!(settings.public && settings.public.allowGuestCheckout);\n  },\n\n  /**\n   * canInviteToGroup - client (similar to server/api canInviteToGroup)\n   * @summary checks if the user making the request is allowed to make invitation to that group\n   * @param {Object} options -\n   * @param {Object} options.group - group to invite to\n   * @param {Object} options.user - user object  making the invite (Meteor.user())\n   * @return {Boolean} -\n   */\n  canInviteToGroup: function (options) {\n    var group = options.group;\n    var user = options.user;\n\n    if (!user) {\n      user = Meteor.user();\n    }\n\n    var userPermissions = user.roles[group.shopId];\n    var groupPermissions = group.permissions; // granting invitation right for user with `owner` role in a shop\n\n    if (this.hasPermission([\"owner\"], Meteor.userId(), group.shopId)) {\n      return true;\n    } // checks that userPermissions includes all elements from groupPermissions\n    // we are not using Reaction.hasPermission here because it returns true if the user has at least one\n\n\n    return _difference(groupPermissions, userPermissions).length === 0;\n  },\n\n  /**\n   * @description showActionView\n   *\n   * @param {String} viewData {label, template, data}\n   * @returns {String} Session \"admin/showActionView\"\n   */\n  showActionView: function (viewData) {\n    Session.set(\"admin/showActionView\", true);\n    this.setActionView(viewData);\n  },\n  isActionViewOpen: function () {\n    return Session.equals(\"admin/showActionView\", true);\n  },\n  isActionViewDetailOpen: function () {\n    return Session.equals(\"admin/showActionViewDetail\", true);\n  },\n  setActionView: function (viewData) {\n    this.hideActionViewDetail();\n\n    if (viewData) {\n      var viewStack;\n\n      if (Array.isArray(viewData)) {\n        viewStack = viewData;\n      } else {\n        viewStack = [viewData];\n      }\n\n      Session.set(\"admin/actionView\", viewStack);\n    } else {\n      var registryItem = this.getRegistryForCurrentRoute(\"settings\");\n\n      if (registryItem) {\n        this.setActionView(registryItem);\n      } else {\n        this.setActionView({\n          template: \"blankControls\"\n        });\n      }\n    }\n  },\n  pushActionView: function (viewData) {\n    Session.set(\"admin/showActionView\", true);\n    var actionViewStack = Session.get(\"admin/actionView\");\n\n    if (viewData) {\n      actionViewStack.push(viewData);\n      Session.set(\"admin/actionView\", actionViewStack);\n    } else {\n      var registryItem = this.getRegistryForCurrentRoute(\"settings\");\n\n      if (registryItem) {\n        this.pushActionView(registryItem);\n      } else {\n        this.pushActionView({\n          template: \"blankControls\"\n        });\n      }\n    }\n  },\n  isActionViewAtRootView: function () {\n    var actionViewStack = Session.get(\"admin/actionView\");\n\n    if (Array.isArray(actionViewStack) && actionViewStack.length === 1) {\n      return true;\n    }\n\n    return false;\n  },\n  popActionView: function () {\n    var actionViewStack = Session.get(\"admin/actionView\");\n    actionViewStack.pop();\n    Session.set(\"admin/actionView\", actionViewStack);\n    this.setActionViewDetail({}, {\n      open: false\n    });\n  },\n  setActionViewDetail: function (viewData) {\n    var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n    var open = options.open;\n    Session.set(\"admin/showActionView\", true);\n    Session.set(\"admin/showActionViewDetail\", typeof open === \"boolean\" ? open : true);\n    Session.set(\"admin/detailView\", [viewData]);\n  },\n  pushActionViewDetail: function (viewData) {\n    Session.set(\"admin/showActionView\", true);\n    Session.set(\"admin/showActionViewDetail\", true);\n    var detailViewStack = Session.get(\"admin/detailView\");\n\n    if (viewData) {\n      detailViewStack.push(viewData);\n      Session.set(\"admin/detailView\", detailViewStack);\n    }\n  },\n  popActionViewDetail: function () {\n    var detailViewStack = Session.get(\"admin/detailView\");\n    detailViewStack.pop();\n    Session.set(\"admin/detailView\", detailViewStack);\n  },\n  isActionViewDetailAtRootView: function () {\n    var actionViewDetailStack = Session.get(\"admin/detailView\");\n\n    if (Array.isArray(actionViewDetailStack) && actionViewDetailStack.length === 1) {\n      return true;\n    }\n\n    return false;\n  },\n  getActionView: function () {\n    var actionViewStack = Session.get(\"admin/actionView\");\n\n    if (Array.isArray(actionViewStack) && actionViewStack.length) {\n      return actionViewStack.pop();\n    }\n\n    return {};\n  },\n  getActionViewDetail: function () {\n    var detailViewStack = Session.get(\"admin/detailView\");\n\n    if (Array.isArray(detailViewStack) && detailViewStack.length) {\n      return detailViewStack.pop();\n    }\n\n    return {};\n  },\n  hideActionView: function () {\n    Session.set(\"admin/showActionView\", false);\n    this.clearActionView();\n  },\n  hideActionViewDetail: function () {\n    Session.set(\"admin/showActionViewDetail\", false);\n    this.clearActionViewDetail();\n  },\n  clearActionView: function () {\n    Session.set(\"admin/actionView\", [{\n      label: \"\",\n      i18nKeyLabel: \"\"\n    }]);\n    Session.set(\"admin/detailView\", [{\n      label: \"\",\n      i18nKeyLabel: \"\"\n    }]);\n  },\n  clearActionViewDetail: function () {\n    Session.set(\"admin/detailView\", [{\n      label: \"\",\n      i18nKeyLabel: \"\"\n    }]);\n  },\n  getCurrentTag: function () {\n    if (this.Router.getRouteName() === \"tag\") {\n      return this.Router.current().params.slug;\n    }\n  },\n  getRegistryForCurrentRoute: function () {\n    var provides = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : \"dashboard\";\n    this.Router.watchPathChange();\n    var currentRouteName = this.Router.getRouteName();\n    var currentRoute = this.Router.current();\n    var template = currentRoute.route.options.template; // find registry entries for routeName\n\n    var reactionApp = Packages.findOne({\n      \"registry.name\": currentRouteName,\n      \"registry.provides\": provides,\n      \"enabled\": true\n    }, {\n      enabled: 1,\n      registry: 1,\n      route: 1,\n      name: 1,\n      label: 1,\n      settings: 1\n    }); // valid application\n\n    if (reactionApp) {\n      var settingsData = _find(reactionApp.registry, function (item) {\n        return item.provides && item.provides.includes(provides) && item.template === template;\n      });\n\n      return settingsData;\n    }\n\n    Logger.debug(\"getRegistryForCurrentRoute not found\", template, provides);\n    return {};\n  },\n\n  /**\n   * getMarketplaceSettingsFromPackages finds the enabled `reaction-marketplace` package for\n   * the primary shop and returns the settings\n   * @method getMarketplaceSettingsFromPackages\n   * @return {Object} The marketplace settings from the primary shop or undefined\n   */\n  getMarketplaceSettings: function () {\n    var marketplaceSettings = Packages.findOne({\n      name: \"reaction-marketplace\",\n      shopId: this.getPrimaryShopId(),\n      // the primary shop always owns the marketplace settings\n      enabled: true // only use the marketplace settings if marketplace is enabled\n\n    });\n    return marketplaceSettings && marketplaceSettings.settings;\n  }\n});\n\n/**\n * createCountryCollection\n * Create a client-side only collection of Countries for a dropdown form\n * properly sorted*\n * @param {Object} countries -  The countries array on the Shop collection\n * @returns {Array} countryOptions - Sorted array of countries\n */\nfunction createCountryCollection(countries) {\n  check(countries, Object);\n  var countryOptions = [];\n\n  for (var locale in meteorBabelHelpers.sanitizeForInObject(countries)) {\n    if ({}.hasOwnProperty.call(countries, locale)) {\n      var country = countries[locale];\n      countryOptions.push({\n        label: country.name,\n        value: locale\n      });\n    }\n  }\n\n  countryOptions.sort(function (a, b) {\n    if (a.label < b.label) {\n      return -1;\n    }\n\n    if (a.label > b.label) {\n      return 1;\n    }\n\n    return 0;\n  });\n\n  for (var _i2 = 0; _i2 < countryOptions.length; _i2++) {\n    var _country = countryOptions[_i2];\n    Countries.insert(_country);\n  }\n\n  return countryOptions;\n}\n/**\n * getDep\n * Gets the dependency for the key if available, else creates\n * a new dependency for the key and returns it.\n * @param {String} -  The key to get the dependency for\n * @returns {Tracker.Dependency}\n */\n\n\nfunction getDep(key) {\n  if (!deps.has(key)) {\n    deps.set(key, new Tracker.Dependency());\n  }\n\n  return deps.get(key);\n}","map":{"version":3,"sources":["client/modules/core/main.js"],"names":["module","export","userPrefs","_find","watch","require","v","_difference","_uniq","store","MeteorAccounts","Accounts","Meteor","Session","check","Tracker","ReactiveVar","ReactiveDict","Roles","Logger","Countries","localeDep","Packages","Shops","Router","reactionState","undefined","val","newVal","JSON","stringify","deps","Map","exportDefault","_shopId","_primaryShopId","marketplace","_ready","Locale","init","autorun","Subscriptions","PrimaryShopPackages","ready","marketplacePkgSettings","getMarketplaceSettings","public","enabled","shop","PrimaryShop","findOne","shopType","primaryShopId","_id","primaryShopName","name","merchantLocale","createCountryCollection","locales","countries","locale","get","currency","localeCurrency","split","currencies","rate","changed","shopCurrency","MerchantShops","absoluteUrl","host","domain","shopId","storedShopId","getUserPreferences","domains","shopName","state","hasPermission","checkPermissions","checkUserId","checkGroup","group","getShopId","GLOBAL_GROUP","permissions","id","userId","roleCheck","push","userIsInRole","validateUserId","clearTimeout","reload","loggingIn","nonreactive","setTimeout","hasDashboardAccessForAnyShop","options","user","roles","hasPermissions","Object","keys","find","role","permission","hasDashboardAccessForMultipleShops","adminShopIds","getShopsForUser","Array","isArray","length","hasOwnerAccess","ownerPermissions","hasAdminAccess","adminPermissions","hasDashboardAccess","dashboardPermissions","hasShopSwitcherAccess","getSellerShopId","noFallback","getGroupsForUser","packageName","preference","defaultValue","getDep","depend","packageSettings","setUserPreferences","value","syncedPackages","indexOf","update","$set","set","updateUserPreferences","values","currentPreference","getPrimaryShopId","getPrimaryShopName","getPrimaryShopPrefix","getSlug","toLowerCase","getPrimaryShopSettings","settings","getPrimaryShopCurrency","setShopId","call","getShopName","providedShopId","getShopPrefix","pathFor","hash","shopSlug","getShopSettings","getShopCurrency","isPreview","viewAs","getPackageSettings","query","getPackageSettingsWithOptions","allowGuestCheckout","canInviteToGroup","userPermissions","groupPermissions","showActionView","viewData","setActionView","isActionViewOpen","equals","isActionViewDetailOpen","hideActionViewDetail","viewStack","registryItem","getRegistryForCurrentRoute","template","pushActionView","actionViewStack","isActionViewAtRootView","popActionView","pop","setActionViewDetail","open","pushActionViewDetail","detailViewStack","popActionViewDetail","isActionViewDetailAtRootView","actionViewDetailStack","getActionView","getActionViewDetail","hideActionView","clearActionView","clearActionViewDetail","label","i18nKeyLabel","getCurrentTag","getRouteName","current","params","slug","provides","watchPathChange","currentRouteName","currentRoute","route","reactionApp","registry","settingsData","item","includes","debug","marketplaceSettings","countryOptions","hasOwnProperty","country","sort","a","b","insert","key","has","Dependency"],"mappings":"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","sourcesContent":["import _ from \"lodash\";\nimport store from \"store\";\nimport { Accounts as MeteorAccounts } from \"meteor/accounts-base\";\nimport { Meteor } from \"meteor/meteor\";\nimport { Session } from \"meteor/session\";\nimport { check } from \"meteor/check\";\nimport { Tracker } from \"meteor/tracker\";\nimport { ReactiveVar } from \"meteor/reactive-var\";\nimport { ReactiveDict } from \"meteor/reactive-dict\";\nimport { Roles } from \"meteor/alanning:roles\";\nimport Logger from \"/client/modules/logger\";\nimport { Countries } from \"/client/collections\";\nimport { localeDep } from \"/client/modules/i18n\";\nimport { Packages, Shops, Accounts } from \"/lib/collections\";\nimport { Router } from \"/client/modules/router\";\n\n// Global, private state object for client side\n// This is placed outside the main object to make it a private variable.\n// access using `Reaction.state`\nconst reactionState = new ReactiveDict();\n\nexport const userPrefs = new ReactiveVar(undefined, (val, newVal) => JSON.stringify(val) === JSON.stringify(newVal));\n\nconst deps = new Map();\n/**\n * Reaction namespace\n * Global reaction shop permissions methods and shop initialization\n */\nexport default {\n  _shopId: new ReactiveVar(null), // The active shop\n  _primaryShopId: new ReactiveVar(null), // The first shop created\n  marketplace: { _ready: false }, // Marketplace Settings\n\n  Locale: new ReactiveVar({}),\n\n  init() {\n    Tracker.autorun(() => {\n      // marketplaceSettings come over on the PrimaryShopPackages subscription\n      if (this.Subscriptions.PrimaryShopPackages.ready()) {\n        if (!this.marketplace._ready) {\n          const marketplacePkgSettings = this.getMarketplaceSettings();\n          if (marketplacePkgSettings && marketplacePkgSettings.public) {\n            this.marketplace._ready = true;\n            this.marketplace = marketplacePkgSettings.public;\n            this.marketplace.enabled = true;\n          }\n        }\n      }\n    });\n\n    // Listen for the primary shop subscription and set accordingly\n    Tracker.autorun(() => {\n      let shop;\n      if (this.Subscriptions.PrimaryShop.ready()) {\n        // There should only ever be one \"primary\" shop\n        shop = Shops.findOne({\n          shopType: \"primary\"\n        });\n\n        if (shop) {\n          this.primaryShopId = shop._id;\n          this.primaryShopName = shop.name;\n\n          // We'll initialize locale and currency for the primary shop unless\n          // marketplace settings exist and merchantLocale is set to true\n          if (this.marketplace.merchantLocale !== true) {\n            // initialize local client Countries collection\n            if (!Countries.findOne()) {\n              createCountryCollection(shop.locales.countries);\n            }\n\n            const locale = this.Locale.get() || {};\n\n            // fix for https://github.com/reactioncommerce/reaction/issues/248\n            // we need to keep an eye for rates changes\n            if (typeof locale.locale === \"object\" &&\n                 typeof locale.currency === \"object\" &&\n                 typeof locale.locale.currency === \"string\") {\n              const localeCurrency = locale.locale.currency.split(\",\")[0];\n              if (typeof shop.currencies[localeCurrency] === \"object\") {\n                if (typeof shop.currencies[localeCurrency].rate === \"number\") {\n                  locale.currency.rate = shop.currencies[localeCurrency].rate;\n                  localeDep.changed();\n                }\n              }\n            }\n            // we are looking for a shopCurrency changes here\n            if (typeof locale.shopCurrency === \"object\") {\n              locale.shopCurrency = shop.currencies[shop.currency];\n              localeDep.changed();\n            }\n          }\n        }\n      }\n    });\n\n    // Listen for active shop change\n    return Tracker.autorun(() => {\n      let shop;\n      if (this.Subscriptions.MerchantShops.ready()) {\n        // get domain (e.g localhost) from absolute url (e.g http://localhost:3000/)\n        const [, , host] = Meteor.absoluteUrl().split(\"/\");\n        const [domain] = host.split(\":\");\n\n        // if we don't have an active shopId, try to retreive it from the userPreferences object\n        // and set the shop from the storedShopId\n        if (!this.shopId) {\n          const storedShopId = this.getUserPreferences(\"reaction\", \"activeShopId\");\n          if (storedShopId) {\n            shop = Shops.findOne({\n              _id: storedShopId\n            });\n          } else {\n            shop = Shops.findOne({\n              domains: domain\n            });\n          }\n        }\n\n        if (shop) {\n          // Only set shopId if it hasn't been set yet\n          if (!this.shopId) {\n            this.shopId = shop._id;\n            this.shopName = shop.name;\n          }\n\n          // We only use the active shop to setup locale if marketplace settings\n          // are enabled and merchantLocale is set to true\n          if (this.marketplace.merchantLocale === true) {\n          // initialize local client Countries collection\n            if (!Countries.findOne()) {\n              createCountryCollection(shop.locales.countries);\n            }\n\n            const locale = this.Locale.get() || {};\n\n            // fix for https://github.com/reactioncommerce/reaction/issues/248\n            // we need to keep an eye for rates changes\n            if (typeof locale.locale === \"object\" &&\n            typeof locale.currency === \"object\" &&\n            typeof locale.locale.currency === \"string\") {\n              const localeCurrency = locale.locale.currency.split(\",\")[0];\n              if (typeof shop.currencies[localeCurrency] === \"object\") {\n                if (typeof shop.currencies[localeCurrency].rate === \"number\") {\n                  locale.currency.rate = shop.currencies[localeCurrency].rate;\n                  localeDep.changed();\n                }\n              }\n            }\n            // we are looking for a shopCurrency changes here\n            if (typeof locale.shopCurrency === \"object\") {\n              locale.shopCurrency = shop.currencies[shop.currency];\n              localeDep.changed();\n            }\n          }\n          return this;\n        }\n      }\n    });\n  },\n\n  // Return global \"reactionState\" Reactive Dict\n  get state() {\n    return reactionState;\n  },\n\n  /**\n   * hasPermission - client\n   * client permissions checks\n   * hasPermission exists on both the server and the client.\n   *\n   * @param {String | Array} checkPermissions -String or Array of permissions if empty, defaults to \"admin, owner\"\n   * @param {String} checkUserId - userId, defaults to Meteor.userId()\n   * @param {String} checkGroup group - default to shopId\n   * @return {Boolean} Boolean - true if has permission\n   */\n  hasPermission(checkPermissions, checkUserId, checkGroup) {\n    let group;\n    // default group to the shop or global if shop isn't defined for some reason.\n    if (checkGroup !== undefined && typeof checkGroup === \"string\") {\n      group = checkGroup;\n    } else {\n      group = this.getShopId() || Roles.GLOBAL_GROUP;\n    }\n\n    let permissions = [\"owner\"];\n    let id = \"\";\n    const userId = checkUserId || Meteor.userId();\n    //\n    // local roleCheck function\n    // is the bulk of the logic\n    // called out a userId is validated.\n    //\n    function roleCheck() {\n      // permissions can be either a string or an array\n      // we'll force it into an array and use that\n      if (checkPermissions === undefined) {\n        permissions = [\"owner\"];\n      } else if (typeof checkPermissions === \"string\") {\n        permissions = [checkPermissions];\n      } else {\n        permissions = checkPermissions;\n      }\n      // if the user has owner permissions we'll always check if those roles are enough\n      // By adding the \"owner\" role to the permissions list, we are making hasPermission always return\n      // true for \"owners\". This gives owners global access.\n      // TODO: Review this way of granting global access for owners\n      permissions.push(\"owner\");\n      permissions = _.uniq(permissions);\n\n      //\n      // return if user has permissions in the group\n      //\n      if (Roles.userIsInRole(userId, permissions, group)) {\n        return true;\n      }\n\n      // global roles check\n      // TODO: Review this commented out code\n      /*\n\n      const sellerShopPermissions = Roles.getGroupsForUser(userId, \"admin\");\n      // we're looking for seller permissions.\n      if (sellerShopPermissions) {\n        // loop through shops roles and check permissions\n        for (const key in sellerShopPermissions) {\n          if (key) {\n            const shop = sellerShopPermissions[key];\n            if (Roles.userIsInRole(userId, permissions, shop)) {\n              return true;\n            }\n          }\n        }\n      }*/\n      // no specific permissions found returning false\n      return false;\n    }\n\n    //\n    // check if a user id has been found\n    // in line 156 setTimeout\n    //\n    function validateUserId() {\n      if (Meteor.userId()) {\n        Meteor.clearTimeout(id);\n        Router.reload();\n        return roleCheck();\n      }\n      return false;\n    }\n\n    //\n    // actual logic block to check permissions\n    // we'll bypass unecessary checks during\n    // a user logging, as we'll check again\n    // when everything is ready\n    //\n    let loggingIn;\n    Tracker.nonreactive(() => {\n      loggingIn = MeteorAccounts.loggingIn();\n    });\n    if (loggingIn === false) {\n      //\n      // this userId check happens because when logout\n      // occurs it takes a few cycles for a new anonymous user\n      // to get created and during this time the user has no\n      // permission, not even guest permissions so we\n      // need to wait and reload the routes. This\n      // mainly affects the logout from dashboard pages\n      //\n      if (!userId) {\n        id = Meteor.setTimeout(validateUserId, 5000);\n      } else {\n        return roleCheck();\n      }\n    }\n    // return false to be safe\n    return false;\n  },\n\n\n  /**\n   * hasDashboardAccessForAnyShop - client\n   * client permission check for any \"owner\", \"admin\", or \"dashboard\" permissions for any shop.\n   *\n   * @todo This could be faster with a dedicated hasAdminDashboard boolean on the user object\n   * @param { Object } options - options object that can be passed a user and/or a set of permissions\n   * @return {Boolean} Boolean - true if has dashboard access for any shop\n   */\n  hasDashboardAccessForAnyShop(options = { user: Meteor.user(), permissions: [\"owner\", \"admin\", \"dashboard\"] }) {\n    const { user, permissions } = options;\n\n    if (!user || !user.roles) {\n      return false;\n    }\n\n    // Nested find that determines if a user has any of the permissions\n    // specified in the `permissions` array for any shop\n    const hasPermissions = Object.keys(user.roles).find((shopId) => user.roles[shopId].find((role) => permissions.find((permission) => permission === role)));\n\n    // Find returns undefined if nothing is found.\n    // This will return true if permissions are found, false otherwise\n    return typeof hasPermissions !== \"undefined\";\n  },\n\n  /**\n   * hasDashboardAccessForAnyShop - client\n   * @summary - client permission check for any \"owner\", \"admin\", or \"dashboard\" permissions for more than one shop.\n   * @return {Boolean} Boolean - true if has dashboard access for more than one shop\n   */\n  hasDashboardAccessForMultipleShops() {\n    const adminShopIds = this.getShopsForUser([\"owner\", \"admin\", \"dashboard\"]);\n    return Array.isArray(adminShopIds) && adminShopIds.length > 1;\n  },\n\n  hasOwnerAccess() {\n    const ownerPermissions = [\"owner\"];\n    return this.hasPermission(ownerPermissions);\n  },\n\n  /**\n   * Checks to see if the user has admin permissions. If a shopId is optionally\n   * passed in, we check for that shopId, otherwise we check against the default\n   * @method hasAdminAccess\n   * @param  {string} [shopId] Optional shopId to check access against\n   * @return {Boolean} true if the user has admin or owner permission,\n   *                   otherwise false\n   */\n  hasAdminAccess(shopId) {\n    const adminPermissions = [\"owner\", \"admin\"];\n    if (shopId) {\n      return this.hasPermission(adminPermissions, Meteor.userId(), shopId);\n    }\n    return this.hasPermission(adminPermissions);\n  },\n\n  hasDashboardAccess() {\n    const dashboardPermissions = [\"owner\", \"admin\", \"dashboard\"];\n    return this.hasPermission(dashboardPermissions);\n  },\n\n  hasShopSwitcherAccess() {\n    return this.hasDashboardAccessForMultipleShops();\n  },\n\n  getSellerShopId(userId = Meteor.userId(), noFallback = false) {\n    if (userId) {\n      const group = Roles.getGroupsForUser(userId, \"admin\")[0];\n      if (group) {\n        return group;\n      }\n    }\n\n    if (noFallback) {\n      return false;\n    }\n\n    return this.getShopId();\n  },\n\n  getUserPreferences(packageName, preference, defaultValue) {\n    getDep(`${packageName}.${preference}`).depend();\n    if (Meteor.user()) {\n      const packageSettings = store.get(packageName);\n      // packageSettings[preference] should not be undefined or null.\n      if (packageSettings && typeof packageSettings[preference] !== \"undefined\" && packageSettings[preference] !== null) {\n        return packageSettings[preference];\n      }\n    }\n\n    return defaultValue || undefined;\n  },\n\n  setUserPreferences(packageName, preference, value) {\n    getDep(`${packageName}.${preference}`).changed();\n    // User preferences are not stored in Meteor.user().profile\n    // to prevent all autorun() with dependency on Meteor.user() to run again.\n    if (Meteor.user()) {\n      // \"reaction\" package settings should be synced to\n      // the Accounts collection.\n      const syncedPackages = [\"reaction\"];\n      if (syncedPackages.indexOf(packageName) > -1) {\n        Accounts.update(Meteor.userId(), {\n          $set: {\n            [`profile.preferences.${packageName}.${preference}`]: value\n          }\n        });\n      }\n    }\n    const packageSettings = store.get(packageName) || {};\n    packageSettings[preference] = value;\n    return store.set(packageName, packageSettings);\n  },\n\n  updateUserPreferences(packageName, preference, values) {\n    const currentPreference = this.getUserPreferences(packageName, preference, {});\n    return this.setUserPreferences(packageName, preference, {\n      ...currentPreference,\n      ...values\n    });\n  },\n\n  // primaryShopId is the first created shop. In a marketplace setting it's\n  // the shop that controls the marketplace and can see all other shops.\n  get primaryShopId() {\n    return this._primaryShopId.get();\n  },\n\n  set primaryShopId(shopId) {\n    this._primaryShopId.set(shopId);\n  },\n\n  getPrimaryShopId() {\n    return this.primaryShopId;\n  },\n\n  getPrimaryShopName() {\n    const shopId = this.getPrimaryShopId();\n    const shop = Shops.findOne({\n      _id: shopId\n    });\n\n    if (shop && shop.name) {\n      return shop.name;\n    }\n\n    // If we can't find the primaryShop return an empty string\n    return \"\";\n  },\n\n  // Primary Shop should probably not have a prefix (or should it be /shop?)\n  getPrimaryShopPrefix() {\n    return `/${this.getSlug(this.getPrimaryShopName().toLowerCase())}`;\n  },\n\n  getPrimaryShopSettings() {\n    const settings = Packages.findOne({\n      name: \"core\",\n      shopId: this.getPrimaryShopId()\n    }) || {};\n    return settings.settings || {};\n  },\n\n  getPrimaryShopCurrency() {\n    const shop = Shops.findOne({\n      _id: this.getPrimaryShopId()\n    });\n\n    return (shop && shop.currency) || \"USD\";\n  },\n\n  // shopId refers to the active shop. For most shoppers this will be the same\n  // as the primary shop, but for administrators this will usually be the shop\n  // they administer.\n  get shopId() {\n    return this._shopId.get();\n  },\n\n  getShopId() {\n    return this.shopId || this.getUserPreferences(\"reaction\", \"activeShopId\");\n  },\n\n  set shopId(id) {\n    this._shopId.set(id);\n  },\n\n  setShopId(id) {\n    if (!id || this.shopId === id) { return; }\n\n    this.shopId = id;\n    this.setUserPreferences(\"reaction\", \"activeShopId\", id);\n\n    Meteor.call(\"shop/resetShopId\");\n  },\n\n  /**\n   * getShopName\n   * @summary gets name of shop by provided shopId, or current active shop if shopId is not provided\n   * @param {String} providedShopID - shopId of shop to return name of\n   * @return {String} - shop name\n   */\n  getShopName(providedShopId) {\n    const shopId = providedShopId || this.getShopId();\n    const shop = Shops.findOne({\n      _id: shopId\n    });\n    return shop && shop.name;\n  },\n\n  getShopPrefix() {\n    const shopName = this.getShopName();\n    if (shopName) {\n      return Router.pathFor(\"index\", {\n        hash: {\n          shopSlug: this.getSlug(shopName.toLowerCase())\n        }\n      });\n    }\n  },\n\n  getShopSettings() {\n    const settings = Packages.findOne({\n      name: \"core\",\n      shopId: this.shopId\n    }) || {};\n    return settings.settings || {};\n  },\n\n  getShopCurrency() {\n    const shop = Shops.findOne({\n      _id: this.shopId\n    });\n\n    return (shop && shop.currency) || \"USD\";\n  },\n\n  isPreview() {\n    const viewAs = this.getUserPreferences(\"reaction-dashboard\", \"viewAs\", \"administrator\");\n\n    if (viewAs === \"customer\") {\n      return true;\n    }\n\n    return false;\n  },\n\n  getPackageSettings(name) {\n    const shopId = this.getShopId();\n    const query = { name };\n\n    if (shopId) {\n      query.shopId = shopId;\n    }\n\n    return Packages.findOne(query);\n  },\n\n  getPackageSettingsWithOptions(options) {\n    const query = options;\n    return Packages.findOne(query);\n  },\n\n  allowGuestCheckout() {\n    const settings = this.getShopSettings();\n    // we can disable in admin, let's check.\n    return !!(settings.public && settings.public.allowGuestCheckout);\n  },\n  /**\n   * canInviteToGroup - client (similar to server/api canInviteToGroup)\n   * @summary checks if the user making the request is allowed to make invitation to that group\n   * @param {Object} options -\n   * @param {Object} options.group - group to invite to\n   * @param {Object} options.user - user object  making the invite (Meteor.user())\n   * @return {Boolean} -\n   */\n  canInviteToGroup(options) {\n    const { group } = options;\n    let { user } = options;\n    if (!user) {\n      user = Meteor.user();\n    }\n    const userPermissions = user.roles[group.shopId];\n    const groupPermissions = group.permissions;\n\n    // granting invitation right for user with `owner` role in a shop\n    if (this.hasPermission([\"owner\"], Meteor.userId(), group.shopId)) {\n      return true;\n    }\n\n    // checks that userPermissions includes all elements from groupPermissions\n    // we are not using Reaction.hasPermission here because it returns true if the user has at least one\n    return _.difference(groupPermissions, userPermissions).length === 0;\n  },\n  /**\n   * @description showActionView\n   *\n   * @param {String} viewData {label, template, data}\n   * @returns {String} Session \"admin/showActionView\"\n   */\n  showActionView(viewData) {\n    Session.set(\"admin/showActionView\", true);\n    this.setActionView(viewData);\n  },\n\n  isActionViewOpen() {\n    return Session.equals(\"admin/showActionView\", true);\n  },\n\n  isActionViewDetailOpen() {\n    return Session.equals(\"admin/showActionViewDetail\", true);\n  },\n\n  setActionView(viewData) {\n    this.hideActionViewDetail();\n    if (viewData) {\n      let viewStack;\n\n      if (Array.isArray(viewData)) {\n        viewStack = viewData;\n      } else {\n        viewStack = [viewData];\n      }\n\n      Session.set(\"admin/actionView\", viewStack);\n    } else {\n      const registryItem = this.getRegistryForCurrentRoute(\"settings\");\n\n      if (registryItem) {\n        this.setActionView(registryItem);\n      } else {\n        this.setActionView({\n          template: \"blankControls\"\n        });\n      }\n    }\n  },\n\n  pushActionView(viewData) {\n    Session.set(\"admin/showActionView\", true);\n\n    const actionViewStack = Session.get(\"admin/actionView\");\n\n    if (viewData) {\n      actionViewStack.push(viewData);\n      Session.set(\"admin/actionView\", actionViewStack);\n    } else {\n      const registryItem = this.getRegistryForCurrentRoute(\"settings\");\n\n      if (registryItem) {\n        this.pushActionView(registryItem);\n      } else {\n        this.pushActionView({ template: \"blankControls\" });\n      }\n    }\n  },\n\n  isActionViewAtRootView() {\n    const actionViewStack = Session.get(\"admin/actionView\");\n\n    if (Array.isArray(actionViewStack) && actionViewStack.length === 1) {\n      return true;\n    }\n\n    return false;\n  },\n\n  popActionView() {\n    const actionViewStack = Session.get(\"admin/actionView\");\n    actionViewStack.pop();\n\n    Session.set(\"admin/actionView\", actionViewStack);\n\n    this.setActionViewDetail({}, { open: false });\n  },\n\n  setActionViewDetail(viewData, options = {}) {\n    const { open } = options;\n\n    Session.set(\"admin/showActionView\", true);\n    Session.set(\"admin/showActionViewDetail\", typeof open === \"boolean\" ? open : true);\n    Session.set(\"admin/detailView\", [viewData]);\n  },\n\n  pushActionViewDetail(viewData) {\n    Session.set(\"admin/showActionView\", true);\n    Session.set(\"admin/showActionViewDetail\", true);\n\n    const detailViewStack = Session.get(\"admin/detailView\");\n\n    if (viewData) {\n      detailViewStack.push(viewData);\n      Session.set(\"admin/detailView\", detailViewStack);\n    }\n  },\n\n  popActionViewDetail() {\n    const detailViewStack = Session.get(\"admin/detailView\");\n    detailViewStack.pop();\n\n    Session.set(\"admin/detailView\", detailViewStack);\n  },\n\n  isActionViewDetailAtRootView() {\n    const actionViewDetailStack = Session.get(\"admin/detailView\");\n\n    if (Array.isArray(actionViewDetailStack) && actionViewDetailStack.length === 1) {\n      return true;\n    }\n\n    return false;\n  },\n\n  getActionView() {\n    const actionViewStack = Session.get(\"admin/actionView\");\n\n    if (Array.isArray(actionViewStack) && actionViewStack.length) {\n      return actionViewStack.pop();\n    }\n\n    return {};\n  },\n\n  getActionViewDetail() {\n    const detailViewStack = Session.get(\"admin/detailView\");\n\n    if (Array.isArray(detailViewStack) && detailViewStack.length) {\n      return detailViewStack.pop();\n    }\n\n    return {};\n  },\n\n  hideActionView() {\n    Session.set(\"admin/showActionView\", false);\n    this.clearActionView();\n  },\n\n  hideActionViewDetail() {\n    Session.set(\"admin/showActionViewDetail\", false);\n    this.clearActionViewDetail();\n  },\n\n  clearActionView() {\n    Session.set(\"admin/actionView\", [{\n      label: \"\",\n      i18nKeyLabel: \"\"\n    }]);\n    Session.set(\"admin/detailView\", [{\n      label: \"\",\n      i18nKeyLabel: \"\"\n    }]);\n  },\n\n  clearActionViewDetail() {\n    Session.set(\"admin/detailView\", [{\n      label: \"\",\n      i18nKeyLabel: \"\"\n    }]);\n  },\n\n  getCurrentTag() {\n    if (this.Router.getRouteName() === \"tag\") {\n      return this.Router.current().params.slug;\n    }\n  },\n\n  getRegistryForCurrentRoute(provides = \"dashboard\") {\n    this.Router.watchPathChange();\n    const currentRouteName = this.Router.getRouteName();\n    const currentRoute = this.Router.current();\n    const { template } = currentRoute.route.options;\n    // find registry entries for routeName\n    const reactionApp = Packages.findOne({\n      \"registry.name\": currentRouteName,\n      \"registry.provides\": provides,\n      \"enabled\": true\n    }, {\n      enabled: 1,\n      registry: 1,\n      route: 1,\n      name: 1,\n      label: 1,\n      settings: 1\n    });\n\n    // valid application\n    if (reactionApp) {\n      const settingsData = _.find(reactionApp.registry, (item) => item.provides && item.provides.includes(provides) && item.template === template);\n      return settingsData;\n    }\n    Logger.debug(\"getRegistryForCurrentRoute not found\", template, provides);\n    return {};\n  },\n\n  /**\n   * getMarketplaceSettingsFromPackages finds the enabled `reaction-marketplace` package for\n   * the primary shop and returns the settings\n   * @method getMarketplaceSettingsFromPackages\n   * @return {Object} The marketplace settings from the primary shop or undefined\n   */\n  getMarketplaceSettings() {\n    const marketplaceSettings = Packages.findOne({\n      name: \"reaction-marketplace\",\n      shopId: this.getPrimaryShopId(), // the primary shop always owns the marketplace settings\n      enabled: true // only use the marketplace settings if marketplace is enabled\n    });\n\n    return marketplaceSettings && marketplaceSettings.settings;\n  }\n\n};\n\n/**\n * createCountryCollection\n * Create a client-side only collection of Countries for a dropdown form\n * properly sorted*\n * @param {Object} countries -  The countries array on the Shop collection\n * @returns {Array} countryOptions - Sorted array of countries\n */\nfunction createCountryCollection(countries) {\n  check(countries, Object);\n  const countryOptions = [];\n  for (const locale in countries) {\n    if ({}.hasOwnProperty.call(countries, locale)) {\n      const country = countries[locale];\n      countryOptions.push({\n        label: country.name,\n        value: locale\n      });\n    }\n  }\n  countryOptions.sort((a, b) => {\n    if (a.label < b.label) {\n      return -1;\n    }\n    if (a.label > b.label) {\n      return 1;\n    }\n    return 0;\n  });\n\n  for (const country of countryOptions) {\n    Countries.insert(country);\n  }\n  return countryOptions;\n}\n\n/**\n * getDep\n * Gets the dependency for the key if available, else creates\n * a new dependency for the key and returns it.\n * @param {String} -  The key to get the dependency for\n * @returns {Tracker.Dependency}\n */\nfunction getDep(key) {\n  if (!deps.has(key)) {\n    deps.set(key, new Tracker.Dependency());\n  }\n  return deps.get(key);\n}\n"]},"sourceType":"script","hash":"4c9cbbddcbc0e3f9023bbf90df5260705af0d436"}
