{"metadata":{},"options":{"plugins":[{"key":"base$0$0","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"generateLetDeclarations":true,"enforceStrictMode":false}},{"key":"transform-meteor-dynamic-import","visitor":{"_exploded":{},"_verified":{},"CallExpression":{"enter":[null]}},"options":{}},{"key":"base$0$2","visitor":{"CallExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"MemberExpression":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true,"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"polyfill":false,"useBuiltIns":false}},{"key":"base$0$3","visitor":{"_exploded":{},"_verified":{},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]}},"options":{"loose":true}},{"key":"base$0$4","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$5","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$6","visitor":{"Program":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"allowTopLevelThis":true,"strictMode":false,"loose":true}},{"key":"base$0$1$0","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"Program":{"enter":[null],"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","throwIfNamespace":true,"useBuiltIns":false}},{"key":"base$0$1$1","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$1$2","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$1","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$2","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$3","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$4","visitor":{"VariableDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"_exploded":true,"BlockStatement":{"enter":[null]},"SwitchStatement":{"enter":[null]},"Program":{"enter":[null]},"_verified":true,"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"base$0$0$5","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"base$0$0$6","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"base$0$0$7","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"base$0$0$8","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"base$0$0$9","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$10","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$11","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]}},"options":{}},{"key":"base$0$0$12","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$13","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$14","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$15","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"base$0$0$16","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]}},"options":{}},{"key":"base$0$0$17","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$18","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$19","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"base$0$0$20","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$21","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"base$0$0$22","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$23","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"regenerator-transform","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]}},"options":{}}],"presets":[],"compact":false,"ast":true,"babelrc":false,"sourceFileName":"imports/plugins/core/ui/client/containers/mediaGallery.js","filename":"imports/plugins/core/ui/client/containers/mediaGallery.js","sourceMaps":true,"envName":"development","cwd":"/Users/estebandev/test-knowledge","passPerPreset":false,"parserOpts":{"sourceType":"module","sourceFileName":"imports/plugins/core/ui/client/containers/mediaGallery.js","plugins":["dynamicImport","classProperties","jsx","jsx","flow","asyncGenerators","objectRestSpread","objectRestSpread","flow","asyncGenerators"]},"generatorOpts":{"filename":"imports/plugins/core/ui/client/containers/mediaGallery.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"imports/plugins/core/ui/client/containers/mediaGallery.js"}},"code":"var _extends2 = _interopRequireDefault(require(\"@babel/runtime/helpers/extends\"));\n\nvar _typeof2 = _interopRequireDefault(require(\"@babel/runtime/helpers/typeof\"));\n\nvar _createClass2 = _interopRequireDefault(require(\"@babel/runtime/helpers/createClass\"));\n\nvar _inheritsLoose2 = _interopRequireDefault(require(\"@babel/runtime/helpers/inheritsLoose\"));\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { \"default\": obj }; }\n\nvar _sortBy;\n\nmodule.watch(require(\"lodash/sortBy\"), {\n  \"default\": function (v) {\n    _sortBy = v;\n  }\n}, 0);\n\nvar _compose;\n\nmodule.watch(require(\"recompose/compose\"), {\n  \"default\": function (v) {\n    _compose = v;\n  }\n}, 1);\nvar React, Component;\nmodule.watch(require(\"react\"), {\n  \"default\": function (v) {\n    React = v;\n  },\n  Component: function (v) {\n    Component = v;\n  }\n}, 2);\nvar PropTypes;\nmodule.watch(require(\"prop-types\"), {\n  \"default\": function (v) {\n    PropTypes = v;\n  }\n}, 3);\nvar Measure;\nmodule.watch(require(\"react-measure\"), {\n  \"default\": function (v) {\n    Measure = v;\n  }\n}, 4);\nvar update;\nmodule.watch(require(\"immutability-helper\"), {\n  \"default\": function (v) {\n    update = v;\n  }\n}, 5);\nvar registerComponent, composeWithTracker;\nmodule.watch(require(\"../../../components/lib\"), {\n  registerComponent: function (v) {\n    registerComponent = v;\n  },\n  composeWithTracker: function (v) {\n    composeWithTracker = v;\n  }\n}, 6);\nvar FileRecord;\nmodule.watch(require(\"@reactioncommerce/file-collections\"), {\n  FileRecord: function (v) {\n    FileRecord = v;\n  }\n}, 7);\nvar Meteor;\nmodule.watch(require(\"meteor/meteor\"), {\n  Meteor: function (v) {\n    Meteor = v;\n  }\n}, 8);\nvar MediaGallery;\nmodule.watch(require(\"../components/media/mediaGallery\"), {\n  \"default\": function (v) {\n    MediaGallery = v;\n  }\n}, 9);\nvar Logger, Reaction;\nmodule.watch(require(\"../../../../../../client/api\"), {\n  Logger: function (v) {\n    Logger = v;\n  },\n  Reaction: function (v) {\n    Reaction = v;\n  }\n}, 10);\nvar ReactionProduct;\nmodule.watch(require(\"../../../../../../lib/api\"), {\n  ReactionProduct: function (v) {\n    ReactionProduct = v;\n  }\n}, 11);\nvar Revisions;\nmodule.watch(require(\"../../../../../../lib/collections\"), {\n  Revisions: function (v) {\n    Revisions = v;\n  }\n}, 12);\nvar isRevisionControlEnabled;\nmodule.watch(require(\"../../../revisions/lib/api\"), {\n  isRevisionControlEnabled: function (v) {\n    isRevisionControlEnabled = v;\n  }\n}, 13);\nvar Media;\nmodule.watch(require(\"../../../files/client\"), {\n  Media: function (v) {\n    Media = v;\n  }\n}, 14);\n\nvar wrapComponent = function (Comp) {\n  var _class, _temp;\n\n  return _temp = _class =\n  /*#__PURE__*/\n  function (_Component) {\n    (0, _inheritsLoose2.default)(MediaGalleryContainer, _Component);\n\n    function MediaGalleryContainer(props) {\n      var _this;\n\n      _this = _Component.call(this, props) || this;\n\n      _this.handleRemoveMedia = function (media) {\n        var imageUrl = media.url({\n          store: \"medium\"\n        });\n        var mediaId = media._id;\n        Alerts.alert({\n          title: \"Remove Media?\",\n          type: \"warning\",\n          showCancelButton: true,\n          imageUrl: imageUrl,\n          imageHeight: 150\n        }, function (isConfirm) {\n          if (isConfirm) {\n            Meteor.call(\"media/remove\", mediaId, function (error) {\n              if (error) {\n                Alerts.toast(error.reason, \"warning\", {\n                  autoHide: 10000\n                });\n              }\n            });\n          } // show media as removed (since it will not disappear until changes are published\n\n        });\n      };\n\n      _this.handleMouseEnterMedia = function (event, media) {\n        var editable = _this.props.editable; // It is confusing for an admin to know what the actual featured media is if it\n        // changes on hover of the other media.\n\n        if (!editable) {\n          _this.setState({\n            featuredMedia: media\n          });\n        }\n      };\n\n      _this.handleMouseLeaveMedia = function () {\n        var editable = _this.props.editable; // It is confusing for an admin to know what the actual featured media is if it\n        // changes on hover of the other media.\n\n        if (!editable) {\n          _this.setState({\n            featuredMedia: null\n          });\n        }\n      };\n\n      _this.handleMoveMedia = function (dragIndex, hoverIndex) {\n        var mediaList = _this.media;\n        var media = mediaList[dragIndex]; // Apply new sort order to variant list\n\n        var newMediaOrder = update(mediaList, {\n          $splice: [[dragIndex, 1], [hoverIndex, 0, media]]\n        }); // Set local state so the component does't have to wait for a round-trip\n        // to the server to get the updated list of variants\n\n        _this.setState({\n          media: newMediaOrder\n        }); // Save the updated positions\n\n\n        var sortedMediaIDs = newMediaOrder.map(function (_ref) {\n          var _id = _ref._id;\n          return _id;\n        });\n        Meteor.call(\"media/updatePriorities\", sortedMediaIDs, function (error) {\n          if (error) {\n            // Go back to using media prop instead of media state so that it doesn't appear successful\n            _this.setState({\n              media: null\n            });\n\n            Alerts.toast(error.reason, \"warning\", {\n              autoHide: 10000\n            });\n          }\n        });\n      };\n\n      _this.handleUpload = function (files) {\n        var productId = ReactionProduct.selectedProductId();\n        var variant = ReactionProduct.selectedVariant();\n\n        if ((0, _typeof2.default)(variant) !== \"object\") {\n          return Alerts.add(\"Select a variant\", \"danger\", {\n            autoHide: true\n          });\n        }\n\n        var variantId = variant._id;\n        var shopId = ReactionProduct.selectedProduct().shopId || Reaction.getShopId();\n        var userId = Meteor.userId();\n        var count = Media.findLocal({\n          \"metadata.variantId\": variantId\n        }).length;\n\n        var _loop = function (file) {\n          // Convert it to a FileRecord\n          var fileRecord = FileRecord.fromFile(file); // Set metadata\n\n          fileRecord.metadata = {\n            ownerId: userId,\n            productId: productId,\n            variantId: variantId,\n            shopId: shopId,\n            priority: count,\n            toGrid: 1 // we need number\n\n          };\n          count += 1; // Listen for upload progress events\n\n          fileRecord.on(\"uploadProgress\", function (uploadProgress) {\n            _this.setState({\n              uploadProgress: uploadProgress\n            });\n          }); // Do the upload. chunkSize is optional and defaults to 5MB\n\n          fileRecord.upload({}) // We insert only AFTER the server has confirmed that all chunks were uploaded\n          .then(function () {\n            Meteor.call(\"media/insert\", fileRecord.document, function (error) {\n              if (error) Alerts.toast(error.reason, \"error\");\n\n              _this.setState({\n                uploadProgress: null\n              });\n            });\n          }).catch(function (error) {\n            _this.setState({\n              uploadProgress: null\n            });\n\n            Logger.error(error);\n          });\n        };\n\n        for (var _iterator = files, _isArray = Array.isArray(_iterator), _i = 0, _iterator = _isArray ? _iterator : _iterator[Symbol.iterator]();;) {\n          var _ref2;\n\n          if (_isArray) {\n            if (_i >= _iterator.length) break;\n            _ref2 = _iterator[_i++];\n          } else {\n            _i = _iterator.next();\n            if (_i.done) break;\n            _ref2 = _i.value;\n          }\n\n          var file = _ref2;\n\n          _loop(file);\n        }\n      };\n\n      _this.state = {\n        dimensions: {\n          width: -1,\n          height: -1\n        },\n        featuredMedia: null,\n        media: null,\n        uploadProgress: null\n      };\n      return _this;\n    }\n\n    var _proto = MediaGalleryContainer.prototype;\n\n    _proto.componentWillReceiveProps = function () {\n      function componentWillReceiveProps(nextProps) {\n        // We need to do this logic only if we've temporarily set media in state for latency compensation\n        if (!this.state.media) return;\n        var previousMediaIds = (this.props.media || []).map(function (_ref3) {\n          var _id = _ref3._id;\n          return _id;\n        });\n        var nextMediaIds = (nextProps.media || []).map(function (_ref4) {\n          var _id = _ref4._id;\n          return _id;\n        }); // If added, moved, or reordered media items since last render, then we can assume\n        // we got updated data in subscription, clear state, and go back to using the prop\n\n        if (JSON.stringify(previousMediaIds) !== JSON.stringify(nextMediaIds)) {\n          this.setState({\n            media: null\n          });\n        }\n      }\n\n      return componentWillReceiveProps;\n    }();\n\n    _proto.render = function () {\n      function render() {\n        var _this2 = this;\n\n        var _state$dimensions = this.state.dimensions,\n            width = _state$dimensions.width,\n            height = _state$dimensions.height;\n        return React.createElement(Measure, {\n          bounds: true,\n          onResize: function (contentRect) {\n            _this2.setState({\n              dimensions: contentRect.bounds\n            });\n          }\n        }, function (_ref5) {\n          var measureRef = _ref5.measureRef;\n          return React.createElement(\"div\", {\n            ref: measureRef\n          }, React.createElement(Comp, (0, _extends2.default)({\n            featuredMedia: _this2.state.featuredMedia,\n            onDrop: _this2.handleUpload,\n            onMouseEnterMedia: _this2.handleMouseEnterMedia,\n            onMouseLeaveMedia: _this2.handleMouseLeaveMedia,\n            onMoveMedia: _this2.handleMoveMedia,\n            onRemoveMedia: _this2.handleRemoveMedia\n          }, _this2.props, {\n            media: _this2.media,\n            mediaGalleryHeight: height,\n            mediaGalleryWidth: width,\n            uploadProgress: _this2.state.uploadProgress\n          })));\n        });\n      }\n\n      return render;\n    }();\n\n    (0, _createClass2.default)(MediaGalleryContainer, [{\n      key: \"media\",\n      get: function () {\n        return this.state.media || this.props.media;\n      }\n    }]);\n    return MediaGalleryContainer;\n  }(Component), _class.propTypes = {\n    editable: PropTypes.bool,\n    id: PropTypes.string,\n    media: PropTypes.arrayOf(PropTypes.object),\n    placement: PropTypes.string // Load first image as featuredImage\n\n  }, _temp;\n};\n\nfunction fetchMediaRevisions() {\n  var productId = ReactionProduct.selectedProductId();\n  var mediaRevisions = Revisions.find({\n    \"parentDocument\": productId,\n    \"documentType\": \"image\",\n    \"workflow.status\": {\n      $nin: [\"revision/published\"]\n    }\n  }).fetch();\n  return mediaRevisions;\n} // resort the media in\n\n\nfunction sortMedia(media) {\n  var sortedMedia = _sortBy(media, function (m) {\n    var _ref6 = m && m.metadata || {},\n        priority = _ref6.priority;\n\n    if (!priority && priority !== 0) {\n      return 1000;\n    }\n\n    return priority;\n  });\n\n  return sortedMedia;\n} // Search through revisions and if we find one for the image, stick it on the object\n\n\nfunction appendRevisionsToMedia(props, media) {\n  if (!isRevisionControlEnabled() || !Reaction.hasPermission(props.permission || [\"createProduct\"])) {\n    return media;\n  }\n\n  var mediaRevisions = fetchMediaRevisions();\n  var newMedia = [];\n\n  for (var _iterator2 = media, _isArray2 = Array.isArray(_iterator2), _i2 = 0, _iterator2 = _isArray2 ? _iterator2 : _iterator2[Symbol.iterator]();;) {\n    var _ref7;\n\n    if (_isArray2) {\n      if (_i2 >= _iterator2.length) break;\n      _ref7 = _iterator2[_i2++];\n    } else {\n      _i2 = _iterator2.next();\n      if (_i2.done) break;\n      _ref7 = _i2.value;\n    }\n\n    var _image = _ref7;\n    _image.revision = undefined;\n\n    for (var _iterator3 = mediaRevisions, _isArray3 = Array.isArray(_iterator3), _i3 = 0, _iterator3 = _isArray3 ? _iterator3 : _iterator3[Symbol.iterator]();;) {\n      var _ref8;\n\n      if (_isArray3) {\n        if (_i3 >= _iterator3.length) break;\n        _ref8 = _iterator3[_i3++];\n      } else {\n        _i3 = _iterator3.next();\n        if (_i3.done) break;\n        _ref8 = _i3.value;\n      }\n\n      var _revision = _ref8;\n\n      if (_revision.documentId === _image._id) {\n        _image.revision = _revision;\n        _image.metadata.priority = _revision.documentData.priority;\n      }\n    }\n\n    newMedia.push(_image);\n  }\n\n  return sortMedia(newMedia);\n}\n\nfunction composer(props, onData) {\n  var media;\n  var editable;\n  var viewAs = Reaction.getUserPreferences(\"reaction-dashboard\", \"viewAs\", \"administrator\");\n\n  if (props.media) {\n    media = appendRevisionsToMedia(props, props.media);\n  }\n\n  if (viewAs === \"customer\") {\n    editable = false;\n  } else {\n    editable = Reaction.hasPermission(props.permission || [\"createProduct\"]);\n  }\n\n  onData(null, {\n    editable: editable,\n    media: media\n  });\n}\n\nregisterComponent(\"MediaGallery\", MediaGallery, [composeWithTracker(composer), wrapComponent]);\nmodule.exportDefault(_compose(composeWithTracker(composer), wrapComponent)(MediaGallery));","map":{"version":3,"sources":["imports/plugins/core/ui/client/containers/mediaGallery.js"],"names":["_sortBy","module","watch","require","v","_compose","React","Component","PropTypes","Measure","update","registerComponent","composeWithTracker","FileRecord","Meteor","MediaGallery","Logger","Reaction","ReactionProduct","Revisions","isRevisionControlEnabled","Media","wrapComponent","Comp","props","handleRemoveMedia","media","imageUrl","url","store","mediaId","_id","Alerts","alert","title","type","showCancelButton","imageHeight","isConfirm","call","error","toast","reason","autoHide","handleMouseEnterMedia","event","editable","setState","featuredMedia","handleMouseLeaveMedia","handleMoveMedia","dragIndex","hoverIndex","mediaList","newMediaOrder","$splice","sortedMediaIDs","map","handleUpload","files","productId","selectedProductId","variant","selectedVariant","add","variantId","shopId","selectedProduct","getShopId","userId","count","findLocal","length","file","fileRecord","fromFile","metadata","ownerId","priority","toGrid","on","uploadProgress","upload","then","document","catch","state","dimensions","width","height","componentWillReceiveProps","nextProps","previousMediaIds","nextMediaIds","JSON","stringify","render","contentRect","bounds","measureRef","propTypes","bool","id","string","arrayOf","object","placement","fetchMediaRevisions","mediaRevisions","find","$nin","fetch","sortMedia","sortedMedia","m","appendRevisionsToMedia","hasPermission","permission","newMedia","image","revision","undefined","documentId","documentData","push","composer","onData","viewAs","getUserPreferences","exportDefault"],"mappings":"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","sourcesContent":["import React, { Component } from \"react\";\nimport PropTypes from \"prop-types\";\nimport Measure from \"react-measure\";\nimport update from \"immutability-helper\";\nimport { compose } from \"recompose\";\nimport { registerComponent, composeWithTracker } from \"@reactioncommerce/reaction-components\";\nimport _ from \"lodash\";\nimport { FileRecord } from \"@reactioncommerce/file-collections\";\nimport { Meteor } from \"meteor/meteor\";\nimport MediaGallery from \"../components/media/mediaGallery\";\nimport { Logger, Reaction } from \"/client/api\";\nimport { ReactionProduct } from \"/lib/api\";\nimport { Revisions } from \"/lib/collections\";\nimport { isRevisionControlEnabled } from \"/imports/plugins/core/revisions/lib/api\";\nimport { Media } from \"/imports/plugins/core/files/client\";\n\nconst wrapComponent = (Comp) => (\n  class MediaGalleryContainer extends Component {\n    static propTypes = {\n      editable: PropTypes.bool,\n      id: PropTypes.string,\n      media: PropTypes.arrayOf(PropTypes.object),\n      placement: PropTypes.string\n    }\n\n    // Load first image as featuredImage\n    constructor(props) {\n      super(props);\n\n      this.state = {\n        dimensions: {\n          width: -1,\n          height: -1\n        },\n        featuredMedia: null,\n        media: null,\n        uploadProgress: null\n      };\n    }\n\n    componentWillReceiveProps(nextProps) {\n      // We need to do this logic only if we've temporarily set media in state for latency compensation\n      if (!this.state.media) return;\n\n      const previousMediaIds = (this.props.media || []).map(({ _id }) => _id);\n      const nextMediaIds = (nextProps.media || []).map(({ _id }) => _id);\n\n      // If added, moved, or reordered media items since last render, then we can assume\n      // we got updated data in subscription, clear state, and go back to using the prop\n      if (JSON.stringify(previousMediaIds) !== JSON.stringify(nextMediaIds)) {\n        this.setState({ media: null });\n      }\n    }\n\n    handleRemoveMedia = (media) => {\n      const imageUrl = media.url({ store: \"medium\" });\n      const mediaId = media._id;\n\n      Alerts.alert({\n        title: \"Remove Media?\",\n        type: \"warning\",\n        showCancelButton: true,\n        imageUrl,\n        imageHeight: 150\n      }, (isConfirm) => {\n        if (isConfirm) {\n          Meteor.call(\"media/remove\", mediaId, (error) => {\n            if (error) {\n              Alerts.toast(error.reason, \"warning\", {\n                autoHide: 10000\n              });\n            }\n          });\n        }\n        // show media as removed (since it will not disappear until changes are published\n      });\n    };\n\n    get media() {\n      return this.state.media || this.props.media;\n    }\n\n    handleMouseEnterMedia = (event, media) => {\n      const { editable } = this.props;\n\n      // It is confusing for an admin to know what the actual featured media is if it\n      // changes on hover of the other media.\n      if (!editable) {\n        this.setState({ featuredMedia: media });\n      }\n    };\n\n    handleMouseLeaveMedia = () => {\n      const { editable } = this.props;\n\n      // It is confusing for an admin to know what the actual featured media is if it\n      // changes on hover of the other media.\n      if (!editable) {\n        this.setState({ featuredMedia: null });\n      }\n    };\n\n    handleMoveMedia = (dragIndex, hoverIndex) => {\n      const mediaList = this.media;\n      const media = mediaList[dragIndex];\n\n      // Apply new sort order to variant list\n      const newMediaOrder = update(mediaList, {\n        $splice: [\n          [dragIndex, 1],\n          [hoverIndex, 0, media]\n        ]\n      });\n\n      // Set local state so the component does't have to wait for a round-trip\n      // to the server to get the updated list of variants\n      this.setState({ media: newMediaOrder });\n\n      // Save the updated positions\n      const sortedMediaIDs = newMediaOrder.map(({ _id }) => _id);\n      Meteor.call(\"media/updatePriorities\", sortedMediaIDs, (error) => {\n        if (error) {\n          // Go back to using media prop instead of media state so that it doesn't appear successful\n          this.setState({ media: null });\n\n          Alerts.toast(error.reason, \"warning\", {\n            autoHide: 10000\n          });\n        }\n      });\n    };\n\n    handleUpload = (files) => {\n      const productId = ReactionProduct.selectedProductId();\n      const variant = ReactionProduct.selectedVariant();\n      if (typeof variant !== \"object\") {\n        return Alerts.add(\"Select a variant\", \"danger\", { autoHide: true });\n      }\n      const variantId = variant._id;\n      const shopId = ReactionProduct.selectedProduct().shopId || Reaction.getShopId();\n      const userId = Meteor.userId();\n      let count = Media.findLocal({\n        \"metadata.variantId\": variantId\n      }).length;\n\n      for (const file of files) {\n        // Convert it to a FileRecord\n        const fileRecord = FileRecord.fromFile(file);\n\n        // Set metadata\n        fileRecord.metadata = {\n          ownerId: userId,\n          productId,\n          variantId,\n          shopId,\n          priority: count,\n          toGrid: 1 // we need number\n        };\n\n        count += 1;\n\n        // Listen for upload progress events\n        fileRecord.on(\"uploadProgress\", (uploadProgress) => {\n          this.setState({ uploadProgress });\n        });\n\n        // Do the upload. chunkSize is optional and defaults to 5MB\n        fileRecord.upload({})\n          // We insert only AFTER the server has confirmed that all chunks were uploaded\n          .then(() => {\n            Meteor.call(\"media/insert\", fileRecord.document, (error) => {\n              if (error) Alerts.toast(error.reason, \"error\");\n              this.setState({ uploadProgress: null });\n            });\n          })\n          .catch((error) => {\n            this.setState({ uploadProgress: null });\n            Logger.error(error);\n          });\n      }\n    };\n\n    render() {\n      const { width, height } = this.state.dimensions;\n\n      return (\n        <Measure\n          bounds\n          onResize={(contentRect) => {\n            this.setState({ dimensions: contentRect.bounds });\n          }}\n        >\n          {({ measureRef }) =>\n            <div ref={measureRef}>\n              <Comp\n                featuredMedia={this.state.featuredMedia}\n                onDrop={this.handleUpload}\n                onMouseEnterMedia={this.handleMouseEnterMedia}\n                onMouseLeaveMedia={this.handleMouseLeaveMedia}\n                onMoveMedia={this.handleMoveMedia}\n                onRemoveMedia={this.handleRemoveMedia}\n                {...this.props}\n                media={this.media}\n                mediaGalleryHeight={height}\n                mediaGalleryWidth={width}\n                uploadProgress={this.state.uploadProgress}\n              />\n            </div>\n          }\n        </Measure>\n      );\n    }\n  }\n);\n\nfunction fetchMediaRevisions() {\n  const productId = ReactionProduct.selectedProductId();\n  const mediaRevisions = Revisions.find({\n    \"parentDocument\": productId,\n    \"documentType\": \"image\",\n    \"workflow.status\": {\n      $nin: [\"revision/published\"]\n    }\n  }).fetch();\n  return mediaRevisions;\n}\n\n// resort the media in\nfunction sortMedia(media) {\n  const sortedMedia = _.sortBy(media, (m) => {\n    const { priority } = (m && m.metadata) || {};\n    if (!priority && priority !== 0) {\n      return 1000;\n    }\n    return priority;\n  });\n  return sortedMedia;\n}\n\n// Search through revisions and if we find one for the image, stick it on the object\nfunction appendRevisionsToMedia(props, media) {\n  if (!isRevisionControlEnabled() || !Reaction.hasPermission(props.permission || [\"createProduct\"])) {\n    return media;\n  }\n  const mediaRevisions = fetchMediaRevisions();\n  const newMedia = [];\n  for (const image of media) {\n    image.revision = undefined;\n    for (const revision of mediaRevisions) {\n      if (revision.documentId === image._id) {\n        image.revision = revision;\n        image.metadata.priority = revision.documentData.priority;\n      }\n    }\n    newMedia.push(image);\n  }\n  return sortMedia(newMedia);\n}\n\nfunction composer(props, onData) {\n  let media;\n  let editable;\n  const viewAs = Reaction.getUserPreferences(\"reaction-dashboard\", \"viewAs\", \"administrator\");\n\n  if (props.media) {\n    media = appendRevisionsToMedia(props, props.media);\n  }\n\n  if (viewAs === \"customer\") {\n    editable = false;\n  } else {\n    editable = Reaction.hasPermission(props.permission || [\"createProduct\"]);\n  }\n\n  onData(null, {\n    editable,\n    media\n  });\n}\n\nregisterComponent(\"MediaGallery\", MediaGallery, [\n  composeWithTracker(composer),\n  wrapComponent\n]);\n\nexport default compose(\n  composeWithTracker(composer),\n  wrapComponent\n)(MediaGallery);\n"]},"sourceType":"script","hash":"ca5248882c41fc8ef5f07c24da2dd5f0568a87d7"}
