{"metadata":{},"options":{"plugins":[{"key":"base$0$0","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"generateLetDeclarations":true,"enforceStrictMode":false}},{"key":"transform-meteor-dynamic-import","visitor":{"_exploded":{},"_verified":{},"CallExpression":{"enter":[null]}},"options":{}},{"key":"base$0$2","visitor":{"CallExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"MemberExpression":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true,"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"polyfill":false,"useBuiltIns":false}},{"key":"base$0$3","visitor":{"_exploded":{},"_verified":{},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]}},"options":{"loose":true}},{"key":"base$0$4","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$5","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$6","visitor":{"Program":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"allowTopLevelThis":true,"strictMode":false,"loose":true}},{"key":"base$0$1$0","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"Program":{"enter":[null],"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","throwIfNamespace":true,"useBuiltIns":false}},{"key":"base$0$1$1","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$1$2","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$1","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$2","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$3","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$4","visitor":{"VariableDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"_exploded":true,"BlockStatement":{"enter":[null]},"SwitchStatement":{"enter":[null]},"Program":{"enter":[null]},"_verified":true,"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"base$0$0$5","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"base$0$0$6","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"base$0$0$7","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"base$0$0$8","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"base$0$0$9","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$10","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$11","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]}},"options":{}},{"key":"base$0$0$12","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$13","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$14","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$15","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"base$0$0$16","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]}},"options":{}},{"key":"base$0$0$17","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$18","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$19","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"base$0$0$20","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$21","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"base$0$0$22","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$23","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"regenerator-transform","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]}},"options":{}}],"presets":[],"compact":false,"ast":true,"babelrc":false,"sourceFileName":"imports/plugins/included/payments-paypal/client/templates/checkout/payflow/payflowForm.js","filename":"imports/plugins/included/payments-paypal/client/templates/checkout/payflow/payflowForm.js","sourceMaps":true,"envName":"development","cwd":"/Users/estebandev/test-knowledge","passPerPreset":false,"parserOpts":{"sourceType":"module","sourceFileName":"imports/plugins/included/payments-paypal/client/templates/checkout/payflow/payflowForm.js","plugins":["dynamicImport","classProperties","jsx","jsx","flow","asyncGenerators","objectRestSpread","objectRestSpread","flow","asyncGenerators"]},"generatorOpts":{"filename":"imports/plugins/included/payments-paypal/client/templates/checkout/payflow/payflowForm.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"imports/plugins/included/payments-paypal/client/templates/checkout/payflow/payflowForm.js"}},"code":"var _typeof2 = _interopRequireDefault(require(\"@babel/runtime/helpers/typeof\"));\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { \"default\": obj }; }\n\nvar Meteor;\nmodule.watch(require(\"meteor/meteor\"), {\n  Meteor: function (v) {\n    Meteor = v;\n  }\n}, 0);\nvar Template;\nmodule.watch(require(\"meteor/templating\"), {\n  Template: function (v) {\n    Template = v;\n  }\n}, 1);\nvar $;\nmodule.watch(require(\"meteor/jquery\"), {\n  $: function (v) {\n    $ = v;\n  }\n}, 2);\nvar AutoForm;\nmodule.watch(require(\"meteor/aldeed:autoform\"), {\n  AutoForm: function (v) {\n    AutoForm = v;\n  }\n}, 3);\nvar Logger;\nmodule.watch(require(\"../../../../../../../../client/modules/logger\"), {\n  \"default\": function (v) {\n    Logger = v;\n  }\n}, 4);\nvar Cart, Shops, Packages;\nmodule.watch(require(\"../../../../../../../../lib/collections\"), {\n  Cart: function (v) {\n    Cart = v;\n  },\n  Shops: function (v) {\n    Shops = v;\n  },\n  Packages: function (v) {\n    Packages = v;\n  }\n}, 5);\nvar PaypalPayment;\nmodule.watch(require(\"../../../../lib/collections/schemas\"), {\n  PaypalPayment: function (v) {\n    PaypalPayment = v;\n  }\n}, 6);\nvar Reaction, i18next;\nmodule.watch(require(\"../../../../../../../../client/api\"), {\n  Reaction: function (v) {\n    Reaction = v;\n  },\n  i18next: function (v) {\n    i18next = v;\n  }\n}, 7);\nvar PayPal;\nmodule.watch(require(\"../../../../lib/api\"), {\n  PayPal: function (v) {\n    PayPal = v;\n  }\n}, 8);\nmodule.watch(require(\"./payflowForm.html\"));\nvar submitting = false;\n\nfunction uiEnd(template, buttonText) {\n  template.$(\".cart-checkout-step *\").removeAttr(\"disabled\");\n  template.$(\"#btn-complete-order\").text(buttonText);\n  return template.$(\"#btn-processing\").addClass(\"hidden\");\n}\n\nfunction paymentAlert(errorMessage) {\n  return $(\".alert\").removeClass(\"hidden\").text(errorMessage);\n}\n\nfunction hidePaymentAlert() {\n  return $(\".alert\").addClass(\"hidden\").text(\"\");\n}\n\nfunction getError(error, detailSubpart) {\n  if (error) {\n    if (error.response) {\n      return error.response[detailSubpart];\n    }\n  }\n\n  return undefined;\n}\n\nfunction handlePaypalSubmitError(error) {\n  var results = [];\n  var singleError = getError(error, \"error_description\");\n  var serverError = getError(error, \"message\");\n  var errors = getError(error, \"response\") || [];\n\n  if (singleError) {\n    return paymentAlert(\"Oops! \" + singleError);\n  } else if (errors.length) {\n    for (var i = 0, len = errors.length; i < len; i += 1) {\n      var thisError = errors[i];\n      var formattedError = \"Oops! \" + thisError.issue + \": \" + thisError.field.split(/[. ]+/).pop().replace(/_/g, \" \");\n      results.push(paymentAlert(formattedError));\n    }\n\n    return results;\n  } else if (serverError) {\n    // Alerts.toast(i18next.t(\"checkout.unknownError\", { err: serverError }), \"error\");\n    return paymentAlert(i18next.t(\"checkout.paymentMethod.unknownError\"));\n  }\n\n  Logger.fatal(\"An unknown error has occurred while processing a Paypal payment\");\n  return paymentAlert(i18next.t(\"checkout.paymentMethod.unknownError\"));\n} //\n// paypal payflow form helpers\n//\n\n\nTemplate.paypalPayflowForm.helpers({\n  PaypalPayment: function () {\n    return PaypalPayment;\n  }\n}); //\n// autoform handling\n//\n\nAutoForm.addHooks(\"paypal-payment-form\", {\n  onSubmit: function (doc) {\n    hidePaymentAlert();\n    var template = this.template;\n    var payerNamePieces = doc.payerName.split(\" \");\n    var form = {\n      first_name: payerNamePieces[0],\n      last_name: payerNamePieces[1],\n      number: doc.cardNumber,\n      expire_month: doc.expireMonth,\n      expire_year: doc.expireYear,\n      cvv2: doc.cvv,\n      type: Reaction.getCardType(doc.cardNumber)\n    };\n    var storedCard = form.type.charAt(0).toUpperCase() + form.type.slice(1) + \" \" + doc.cardNumber.slice(-4);\n    PayPal.authorize(form, {\n      total: Cart.findOne().getTotal(),\n      currency: Shops.findOne().currency\n    }, function (error, transaction) {\n      submitting = false; // todo: check scope\n\n      if (error) {\n        handlePaypalSubmitError(error);\n        uiEnd(template, i18next.t(\"checkout.paymentMethod.resubmit\"));\n      } else if (transaction.saved === true) {\n        var normalizedStatus = transaction.response.state;\n        if (normalizedStatus === \"approved\") normalizedStatus = \"created\";\n        var supportedStatuses = [\"created\", \"failed\", \"canceled\", \"expired\", \"pending\"];\n        if (supportedStatuses.indexOf(normalizedStatus) === -1) normalizedStatus = \"failed\";\n        var normalizedMode;\n\n        switch (transaction.response.intent) {\n          case \"authorize\":\n            normalizedMode = \"authorize\";\n            break;\n\n          case \"sale\":\n          case \"order\":\n          default:\n            normalizedMode = \"capture\";\n            break;\n        } // just auth, not transaction\n\n\n        var transactionId = transaction.response.id; // when auth and transaction\n\n        var authId;\n\n        if ((0, _typeof2.default)(transaction.response.transactions[0].related_resources[0]) === \"object\") {\n          authId = transaction.response.transactions[0].related_resources[0].authorization.id;\n        }\n\n        Meteor.subscribe(\"Packages\", Reaction.getShopId());\n        var packageData = Packages.findOne({\n          name: \"reaction-paypal\",\n          shopId: Reaction.getShopId()\n        });\n        var paymentMethod = {\n          processor: \"PayflowPro\",\n          paymentPackageId: packageData._id,\n          paymentSettingsKey: packageData.registry[0].settingsKey,\n          storedCard: storedCard,\n          method: \"credit\",\n          authorization: authId,\n          transactionId: transactionId,\n          metadata: {\n            transactionId: transactionId,\n            authorizationId: authId\n          },\n          amount: Number(transaction.response.transactions[0].amount.total),\n          status: normalizedStatus,\n          mode: normalizedMode,\n          createdAt: new Date(transaction.response.create_time),\n          updatedAt: new Date(transaction.response.update_time),\n          transactions: []\n        };\n        paymentMethod.transactions.push(transaction.response);\n        Meteor.call(\"cart/submitPayment\", paymentMethod);\n      } else {\n        handlePaypalSubmitError(transaction.error);\n        uiEnd(template, i18next.t(\"checkout.paymentMethod.resubmit\"));\n      }\n    });\n    return false;\n  },\n  beginSubmit: function () {\n    this.template.$(\".cart-checkout-step *\").attr(\"disabled\", true);\n    this.template.$(\"#btn-complete-order\").text(i18next.t(\"checkout.paymentMethod.submitting\"));\n    return this.template.$(\"#btn-processing\").removeClass(\"hidden\");\n  },\n  endSubmit: function () {\n    if (!submitting) {\n      return uiEnd(this.template, i18next.t(\"checkout.completeYourOrder\"));\n    }\n\n    return undefined;\n  }\n});","map":{"version":3,"sources":["imports/plugins/included/payments-paypal/client/templates/checkout/payflow/payflowForm.js"],"names":["Meteor","module","watch","require","v","Template","$","AutoForm","Logger","Cart","Shops","Packages","PaypalPayment","Reaction","i18next","PayPal","submitting","uiEnd","template","buttonText","removeAttr","text","addClass","paymentAlert","errorMessage","removeClass","hidePaymentAlert","getError","error","detailSubpart","response","undefined","handlePaypalSubmitError","results","singleError","serverError","errors","length","i","len","thisError","formattedError","issue","field","split","pop","replace","push","t","fatal","paypalPayflowForm","helpers","addHooks","onSubmit","doc","payerNamePieces","payerName","form","first_name","last_name","number","cardNumber","expire_month","expireMonth","expire_year","expireYear","cvv2","cvv","type","getCardType","storedCard","charAt","toUpperCase","slice","authorize","total","findOne","getTotal","currency","transaction","saved","normalizedStatus","state","supportedStatuses","indexOf","normalizedMode","intent","transactionId","id","authId","transactions","related_resources","authorization","subscribe","getShopId","packageData","name","shopId","paymentMethod","processor","paymentPackageId","_id","paymentSettingsKey","registry","settingsKey","method","metadata","authorizationId","amount","Number","status","mode","createdAt","Date","create_time","updatedAt","update_time","call","beginSubmit","attr","endSubmit"],"mappings":"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","sourcesContent":["/* eslint camelcase: 0 */\nimport { Meteor } from \"meteor/meteor\";\nimport { Template } from \"meteor/templating\";\nimport { $ } from \"meteor/jquery\";\nimport { AutoForm } from \"meteor/aldeed:autoform\";\nimport Logger from \"/client/modules/logger\";\nimport { Cart, Shops, Packages } from \"/lib/collections\";\nimport { PaypalPayment } from \"/imports/plugins/included/payments-paypal/lib/collections/schemas\";\nimport { Reaction, i18next } from \"/client/api\";\nimport { PayPal } from \"/imports/plugins/included/payments-paypal/lib/api\";\nimport \"./payflowForm.html\";\n\nlet submitting = false;\n\nfunction uiEnd(template, buttonText) {\n  template.$(\".cart-checkout-step *\").removeAttr(\"disabled\");\n  template.$(\"#btn-complete-order\").text(buttonText);\n  return template.$(\"#btn-processing\").addClass(\"hidden\");\n}\n\nfunction paymentAlert(errorMessage) {\n  return $(\".alert\").removeClass(\"hidden\").text(errorMessage);\n}\n\nfunction hidePaymentAlert() {\n  return $(\".alert\").addClass(\"hidden\").text(\"\");\n}\n\nfunction getError(error, detailSubpart) {\n  if (error) {\n    if (error.response) {\n      return error.response[detailSubpart];\n    }\n  }\n  return undefined;\n}\n\nfunction handlePaypalSubmitError(error) {\n  const results = [];\n  const singleError = getError(error, \"error_description\");\n  const serverError = getError(error, \"message\");\n  const errors = getError(error, \"response\") || [];\n  if (singleError) {\n    return paymentAlert(`Oops! ${singleError}`);\n  } else if (errors.length) {\n    for (let i = 0, len = errors.length; i < len; i += 1) {\n      const thisError = errors[i];\n      const formattedError = `Oops! ${thisError.issue}: ${thisError.field.split(/[. ]+/).pop().replace(/_/g, \" \")}`;\n      results.push(paymentAlert(formattedError));\n    }\n    return results;\n  } else if (serverError) {\n    // Alerts.toast(i18next.t(\"checkout.unknownError\", { err: serverError }), \"error\");\n    return paymentAlert(i18next.t(\"checkout.paymentMethod.unknownError\"));\n  }\n  Logger.fatal(\"An unknown error has occurred while processing a Paypal payment\");\n  return paymentAlert(i18next.t(\"checkout.paymentMethod.unknownError\"));\n}\n\n//\n// paypal payflow form helpers\n//\nTemplate.paypalPayflowForm.helpers({\n  PaypalPayment() {\n    return PaypalPayment;\n  }\n});\n\n//\n// autoform handling\n//\nAutoForm.addHooks(\"paypal-payment-form\", {\n  onSubmit(doc) {\n    hidePaymentAlert();\n    const { template } = this;\n    const payerNamePieces = doc.payerName.split(\" \");\n    const form = {\n      first_name: payerNamePieces[0],\n      last_name: payerNamePieces[1],\n      number: doc.cardNumber,\n      expire_month: doc.expireMonth,\n      expire_year: doc.expireYear,\n      cvv2: doc.cvv,\n      type: Reaction.getCardType(doc.cardNumber)\n    };\n    const storedCard = `${form.type.charAt(0).toUpperCase() + form.type.slice(1)} ${doc.cardNumber.slice(-4)}`;\n    PayPal.authorize(form, {\n      total: Cart.findOne().getTotal(),\n      currency: Shops.findOne().currency\n    }, (error, transaction) => {\n      submitting = false; // todo: check scope\n      if (error) {\n        handlePaypalSubmitError(error);\n        uiEnd(template, i18next.t(\"checkout.paymentMethod.resubmit\"));\n      } else if (transaction.saved === true) {\n        let normalizedStatus = transaction.response.state;\n        if (normalizedStatus === \"approved\") normalizedStatus = \"created\";\n\n        const supportedStatuses = [\"created\", \"failed\", \"canceled\", \"expired\", \"pending\"];\n        if (supportedStatuses.indexOf(normalizedStatus) === -1) normalizedStatus = \"failed\";\n\n        let normalizedMode;\n        switch (transaction.response.intent) {\n          case \"authorize\":\n            normalizedMode = \"authorize\";\n            break;\n          case \"sale\":\n          case \"order\":\n          default:\n            normalizedMode = \"capture\";\n            break;\n        }\n\n        // just auth, not transaction\n        const transactionId = transaction.response.id;\n        // when auth and transaction\n        let authId;\n        if (typeof transaction.response.transactions[0].related_resources[0] === \"object\") {\n          authId = transaction.response.transactions[0].related_resources[0].authorization.id;\n        }\n        Meteor.subscribe(\"Packages\", Reaction.getShopId());\n        const packageData = Packages.findOne({\n          name: \"reaction-paypal\",\n          shopId: Reaction.getShopId()\n        });\n        const paymentMethod = {\n          processor: \"PayflowPro\",\n          paymentPackageId: packageData._id,\n          paymentSettingsKey: packageData.registry[0].settingsKey,\n          storedCard,\n          method: \"credit\",\n          authorization: authId,\n          transactionId,\n          metadata: {\n            transactionId,\n            authorizationId: authId\n          },\n          amount: Number(transaction.response.transactions[0].amount.total),\n          status: normalizedStatus,\n          mode: normalizedMode,\n          createdAt: new Date(transaction.response.create_time),\n          updatedAt: new Date(transaction.response.update_time),\n          transactions: []\n        };\n        paymentMethod.transactions.push(transaction.response);\n        Meteor.call(\"cart/submitPayment\", paymentMethod);\n      } else {\n        handlePaypalSubmitError(transaction.error);\n        uiEnd(template, i18next.t(\"checkout.paymentMethod.resubmit\"));\n      }\n    });\n    return false;\n  },\n  beginSubmit() {\n    this.template.$(\".cart-checkout-step *\").attr(\"disabled\", true);\n    this.template.$(\"#btn-complete-order\").text(i18next.t(\"checkout.paymentMethod.submitting\"));\n    return this.template.$(\"#btn-processing\").removeClass(\"hidden\");\n  },\n  endSubmit() {\n    if (!submitting) {\n      return uiEnd(this.template, i18next.t(\"checkout.completeYourOrder\"));\n    }\n    return undefined;\n  }\n});\n"]},"sourceType":"script","hash":"423776e1352c5495e121e245c059c0acf315fa34"}
